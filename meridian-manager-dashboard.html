<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meridian - Manager Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/konva@10/konva.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #2563eb;
            --accent-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: #f9fafb;
            color: #111827;
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Top Header Bar - Storeganise Style */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow: visible;
        }
        
        .top-header .container-fluid {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            overflow: visible;
        }
        
        .navbar-header {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .navbar-brand {
            padding: 8px 15px;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }
        
        .navbar-brand img {
            height: 32px;
        }
        
        .navbar-toggle {
            display: none;
            background: none;
            border: none;
            padding: 9px 10px;
            margin-top: 8px;
            margin-right: 15px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 0;
            align-items: center;
            flex-shrink: 0;
            overflow: visible;
        }
        
        .navbar-nav li {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .navbar-nav li a {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            white-space: nowrap;
            border-radius: 6px;
            margin: 0 2px;
        }
        
        .navbar-nav li a:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        .navbar-nav li a.active {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        
        .navbar-nav li a i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        
        .jump-to-container {
            margin: 0;
            padding: 0;
        }
        
        .jump-to-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            width: 160px;
            margin-right: 12px;
            background: #ffffff;
            color: #374151;
            transition: all 0.15s ease;
        }
        
        .jump-to-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .jump-to-input::placeholder {
            color: #9ca3af;
        }
        
        .navbar-right li {
            display: flex;
            align-items: center;
            margin: 0;
        }
        
        .navbar-right li:last-child {
            margin-right: 0;
        }
        
        .navbar-right {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
            margin-left: auto;
            flex-shrink: 0;
            overflow: visible;
        }
        
        .navbar-collapse {
            display: flex;
            flex: 1;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            overflow: visible;
            min-width: 0;
        }
        
        .dropdown {
            position: relative;
        }
        
        .dropdown-toggle {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            color: #374151;
            text-decoration: none;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        
        .dropdown-toggle:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        .dropdown-toggle .caret {
            margin-left: 5px;
            border-top: 4px solid;
            border-right: 4px solid transparent;
            border-bottom: 0;
            border-left: 4px solid transparent;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            list-style: none;
            padding: 5px 0;
            margin: 2px 0 0;
            display: none;
            z-index: 1000;
        }
        
        .dropdown.open .dropdown-menu {
            display: block;
        }
        
        .dropdown-menu li {
            margin: 0;
        }
        
        .dropdown-menu li a {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }
        
        .dropdown-menu li a:hover {
            background: #f5f5f5;
        }
        
        .dropdown-menu li a i {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }
        
        .dropdown-menu .divider {
            height: 1px;
            margin: 9px 0;
            overflow: hidden;
            background-color: #e5e5e5;
        }

        .top-header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .top-header-logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .top-nav {
            display: flex;
            gap: 8px;
        }

        .top-nav-item {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
        }

        .top-nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .top-nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            font-weight: 600;
        }

        .top-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .site-switcher {
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar - Storeganise Style */
        .sidebar {
            position: fixed;
            left: 0;
            top: 56px;
            width: 260px;
            height: calc(100vh - 56px);
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
        }
        
        .page-head {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #ffffff;
        }
        
        .page-head h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            line-height: 1.5;
        }
        
        .page-head h3 a {
            color: #333;
            text-decoration: none;
        }
        
        .page-head h3 a:hover {
            color: #0066cc;
        }
        
        .page-head h3 span {
            color: #999;
            margin: 0 4px;
        }
        
        .page-head .label {
            display: inline-block;
            padding: 3px 7px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 3px;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .facility-image-container {
            padding: 0;
            border-bottom: 1px solid #e5e7eb;
            background: #ffffff;
            width: 100%;
            box-sizing: border-box;
        }
        
        .facility-image {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: #ffffff;
            display: block;
            padding: 16px;
        }
        
        .list-group {
            list-style: none;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        .list-group-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.15s ease;
            cursor: pointer;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        .list-group-item:hover {
            background: #f9fafb;
            color: #111827;
        }
        
        .list-group-item.active {
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
            border-left: 3px solid #1d4ed8;
        }
        
        .list-group-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #1d4ed8;
        }
        
        .list-group-item i {
            margin-right: 14px;
            width: 20px;
            text-align: center;
            font-size: 16px;
            opacity: 0.8;
            display: inline-block;
            flex-shrink: 0;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
        }
        
        .list-group-item span:not(.badge) {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .list-group-item:hover i {
            opacity: 1;
        }
        
        .list-group-item.active i {
            opacity: 1;
            color: #1976d2;
        }
        
        .list-group-item .badge {
            background: #bbb;
            color: white;
            padding: 3px 7px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        .list-group-item.active .badge {
            background: #1976d2;
            color: white;
        }

        .facility-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .facility-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .facility-status {
            display: inline-block;
            padding: 4px 8px;
            background: var(--warning);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .facility-illustration {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .nav-list {
            padding: 0 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--gray-700);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .nav-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            background: var(--gray-300);
            color: var(--gray-700);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .nav-item.active .nav-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Main Content - Storeganise Style */
        .main-content {
            margin-left: 260px;
            margin-top: 56px;
            padding: 0;
            min-height: calc(100vh - 56px);
            background: #f9fafb;
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .sgc-table-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .filter {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter button {
            background: none;
            border: none;
            padding: 6px 12px;
            color: #0066cc;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }
        
        .filter button:hover {
            background: #f0f0f0;
        }
        
        .filter--active button {
            background: #e8f4f8;
            color: #0066cc;
            font-weight: 600;
        }
        
        .filter .caret {
            margin-left: 5px;
            border-top: 4px solid;
            border-right: 4px solid transparent;
            border-bottom: 0;
            border-left: 4px solid transparent;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        .btn-link {
            background: none;
            border: none;
            padding: 6px 12px;
            color: #0066cc;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        
        .btn-link:hover {
            text-decoration: underline;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Jobs section styling */
        #jobs-section {
            min-height: 400px;
        }
        
        .jobs-filter-bar {
            background: #ffffff !important;
            visibility: visible !important;
        }
        
        #jobsTableBody {
            visibility: visible !important;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 24px 0;
            padding: 0;
        }
        
        .tab-content {
            padding: 24px;
            background: #f9fafb;
            min-height: calc(100vh - 50px);
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            border-left: 3px solid #1976d2;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .metric-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border-color: #d1d5db;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .metric-change {
            font-size: 13px;
            color: #6b7280;
            font-weight: 400;
        }

        /* Chart Container */
        .chart-container {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
            max-width: 500px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chart-toggle {
            display: flex;
            gap: 8px;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 6px;
        }
        
        .chart-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .chart-toggle-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .chart-toggle-btn.active {
            background: #2563eb;
            color: #ffffff;
        }
        
        .chart-wrapper {
            height: 250px;
            position: relative;
        }

        .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Table */
        .table-container {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .table-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .filter-bar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--gray-50);
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: var(--gray-900);
            cursor: pointer;
        }
        
        /* Jobs Filter Bar */
        .jobs-filter-bar {
            padding: 16px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .filter-chips {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .filter-chip:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        
        .filter-chip.active {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        
        .filter-chip.active:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        .filter-chip i {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .filter-chip-remove {
            background: none;
            border: none;
            color: inherit;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.15s ease;
        }
        
        .filter-chip-remove:hover {
            opacity: 1;
        }
        
        .filter-dropdown {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            color: #2563eb;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.15s ease;
        }
        
        .filter-dropdown:hover {
            background: #f3f4f6;
        }
        
        .filter-dropdown i {
            font-size: 12px;
        }
        
        .job-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .job-type-move-in {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .job-type-move-out {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .job-type-transfer {
            background: #fef3c7;
            color: #92400e;
        }
        
        .job-type-task {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .job-type-lead {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 14px;
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        
        .btn-icon:hover {
            background: #f3f4f6;
            color: #2563eb;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px 20px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 14px 20px;
            border-top: 1px solid #f3f4f6;
            font-size: 14px;
            color: #374151;
            font-weight: 400;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .locked-row {
            background-color: #fef2f2 !important;
            opacity: 0.9;
        }

        .locked-row:hover {
            opacity: 1;
            background-color: #fee2e2 !important;
        }

        .status-available {
            background: var(--success);
            color: white;
        }

        .status-occupied {
            background: var(--accent);
            color: white;
        }

        .status-reserved {
            background: var(--warning);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--gray-600);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Sitemap Canvas */
        .sitemap-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
        }

        .sitemap-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        #sitemapCanvas {
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: var(--gray-50);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 3000;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }
        
        /* Details Section Styles */
        .details-section-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .details-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .details-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .details-section-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .details-icon-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        
        .details-icon-btn:hover {
            background: #eff6ff;
            color: #2563eb;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            background-color: #d1d5db;
            border-radius: 24px;
            transition: background-color 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #2563eb;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
        }
        
        .info-box i {
            color: #3b82f6;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .info-box a {
            color: #2563eb;
            text-decoration: underline;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .language-link {
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .details-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.15s ease;
        }
        
        .details-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .details-textarea:disabled {
            background: #f9fafb;
            cursor: not-allowed;
        }
        
        .location-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .details-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .btn-primary {
            background: #2563eb;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Unit Detail Tabs */
        .unit-detail-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .unit-detail-tab:hover {
            color: #2563eb;
            background: #f3f4f6;
        }
        
        .unit-detail-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }
        
        .unit-detail-tab-content {
            display: none;
        }
        
        .unit-detail-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Top Header - Storeganise Style -->
    <div id="head-nav" class="top-header navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" onclick="toggleMobileMenu()">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#">
                    <img src="https://cdn.prod.website-files.com/6931dc4e8e97334e195432df/69667ee6f82275ff9373308c_Screenshot%202026-01-13%20at%2012.20.31%E2%80%AFPM.png" alt="Meridian" style="height: 32px;">
                </a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="#" onclick="showTopNav('analytics'); return false;"><i class="fas fa-chart-line"></i> <span>Analytics</span></a></li>
                    <li><a href="#" class="active" onclick="showTopNav('sites'); return false;"><i class="fas fa-building"></i> <span>Sites</span></a></li>
                    <li><a href="#" onclick="showTopNav('users'); return false;"><i class="fas fa-user"></i> <span>Users</span></a></li>
                    <li><a href="#" onclick="showTopNav('invoices'); return false;"><i class="fas fa-file-invoice-dollar"></i> <span>Invoices</span></a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <div class="jump-to-container">
                            <input type="text" class="jump-to-input" placeholder="Jump to" id="jumpToInput">
        </div>
                    </li>
                    <li class="dropdown" id="userDropdown">
                        <a class="dropdown-toggle" role="button" onclick="toggleDropdown('userDropdown')">
                            <span id="userName">manager</span> <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a role="menuitem" href="#"><i class="fa fa-fw fa-question"></i> Help</a></li>
                            <li><a role="menuitem" href="#" target="_blank"><i class="far fa-fw fa-user-graduate"></i> Academy</a></li>
                            <li class="divider"></li>
                            <li><a role="menuitem" href="#"><i class="fa-fw far fa-check"></i> English</a></li>
                            <li class="divider"></li>
                            <li><a role="menuitem" href="#"><i class="fa fa-fw fa-cog"></i> Main settings</a></li>
                            <li class="divider"></li>
                            <li><a role="menuitem" href="#" onclick="logout(); return false;"><i class="fa-fw fas fa-sign-out-alt"></i> Log out</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sidebar - Storeganise Style -->
    <div class="sidebar">
        <div class="page-head page-head-small">
            <div class="pull-right">
                <button type="button" class="hidden-print btn btn-link"><i class="fas fa-tags"></i></button>
        </div>
            <h3 style="display: flex; align-items: center; flex-wrap: wrap;">
                <span>
                    <span><a href="#" onclick="return false;">Sites</a> <span style="color: #aaa;">:</span> </span>
                    <span id="facilityName">Loading...</span>
                </span>
                <small>&nbsp;&nbsp;&nbsp; 
                    <small class="label" id="facilityStatusLabel" style="display: none; background-color: #fcf8e3; color: #f0ad4e;">
                        <span>Hidden</span>
                    </small>
                </small>
            </h3>
                </div>
            <ul class="list-group">
                <a class="list-group-item active" onclick="showSection('overview'); return false;" style="cursor: pointer;">
                    <i class="fas fa-chart-line"></i> <span>Overview</span>
                </a>
                <a class="list-group-item" onclick="showSection('details'); return false;" style="cursor: pointer;">
                    <i class="fas fa-info-circle"></i> <span>Details</span>
                </a>
                <a class="list-group-item" onclick="showSection('jobs'); return false;" style="cursor: pointer;">
                    <i class="fas fa-tasks"></i> <span>Jobs</span>
                </a>
                <a class="list-group-item" onclick="showSection('units'); return false;" style="cursor: pointer;">
                    <i class="fas fa-building"></i> <span>Units</span>
                    <span class="badge" id="unitsBadge">0</span>
                </a>
                <a class="list-group-item" onclick="showSection('invoices'); return false;" style="cursor: pointer;">
                    <i class="fas fa-file-invoice-dollar"></i> <span>Invoices</span>
                </a>
                <a class="list-group-item" onclick="showSection('sitemap'); return false;" style="cursor: pointer;">
                    <i class="fas fa-layer-group"></i> <span>Sitemap</span>
                </a>
                <a class="list-group-item" onclick="showSection('unit-types'); return false;" style="cursor: pointer;">
                    <i class="fas fa-list"></i> <span>Unit types</span>
                    <span class="badge" id="unitTypesBadge">0</span>
                </a>
                <a class="list-group-item" onclick="showSection('products'); return false;" style="cursor: pointer;">
                    <i class="fas fa-boxes"></i> <span>Products</span>
                </a>
                <a class="list-group-item" onclick="showSection('customers'); return false;" style="cursor: pointer;">
                    <i class="fas fa-users"></i> <span>Customers</span>
                    <span class="badge" id="customersBadge">0</span>
                </a>
                <a class="list-group-item" onclick="showSection('settings'); return false;" style="cursor: pointer;">
                    <i class="fas fa-cog"></i> <span>Advanced settings</span>
                </a>
                <a class="list-group-item" onclick="showSection('addons'); return false;" style="cursor: pointer;">
                    <i class="fas fa-cubes"></i> <span>Add-ons</span>
                </a>
                <a class="list-group-item" onclick="showSection('history'); return false;" style="cursor: pointer;">
                    <i class="fas fa-history"></i> <span>History</span>
                </a>
            </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Overview Section -->
        <div id="overview-section" class="section active">
            <div class="tab-content">
            <h1 class="page-title">Overview</h1>
            
            <div class="metrics-grid">
                <div class="metric-card" style="border-left: 4px solid #1976d2;">
                    <div class="metric-label">Monthly Revenue</div>
                    <div class="metric-value" id="revenueValue" style="color: #1976d2;">$0</div>
                    <div class="metric-change">Facility Income</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid #10b981;">
                    <div class="metric-label">Occupancy Rate</div>
                    <div class="metric-value" id="occupancyValue" style="color: #10b981;">0%</div>
                    <div class="metric-change" id="occupancyInfo">0 / 0 units</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid #f59e0b;">
                    <div class="metric-label">Active Customers</div>
                    <div class="metric-value" id="customersValue" style="color: #f59e0b;">0</div>
                    <div class="metric-change">With active units</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid #6366f1;">
                    <div class="metric-label">Available Units</div>
                    <div class="metric-value" id="availableValue" style="color: #6366f1;">0</div>
                    <div class="metric-change">Ready to rent</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                <div class="chart-title">Occupancy Breakdown</div>
                    <div class="chart-toggle">
                        <button class="chart-toggle-btn active" onclick="switchChartType('pie')" id="pieBtn">
                            <i class="fas fa-chart-pie"></i> Pie
                        </button>
                        <button class="chart-toggle-btn" onclick="switchChartType('bar')" id="barBtn">
                            <i class="fas fa-chart-bar"></i> Bar
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="occupancyChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Activity</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Action</th>
                            <th>Unit</th>
                            <th>Customer</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr>
                            <td colspan="4" class="loading">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </div>

        <!-- Details Section -->
        <div id="details-section" class="section">
            <div class="tab-content">
                <h1 class="page-title">Facility Details</h1>
                <div id="facilityDetailsContent">
                    <!-- General Information -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">General information</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="toggleEditMode('general')" id="editGeneralBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('general')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="generalInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>Use Markdown for formatting. For more info check out our <a href="#" target="_blank">markdown guide</a></span>
                        </div>
                        <div class="language-selector">
                            <i class="fas fa-flag"></i>
                            <span class="language-link">English</span>
                        </div>
                        <textarea class="details-textarea" id="generalInformation" placeholder="Use this space for general information such as opening times, access directions etc. This content will be displayed in the booking flow to help customers choose the site that is right for them." disabled></textarea>
                        <div class="details-actions" id="generalActions" style="display: none;">
                            <button class="btn btn-primary" onclick="saveDetailsSection('general')">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditMode('general')">Cancel</button>
                        </div>
                    </div>

                    <!-- Site Hours -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">Site hours</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="toggleEditMode('hours')" id="editHoursBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('hours')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="hoursInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>Select if your facility is open 24/7 or set custom hours using Markdown formatting.</span>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="is24Hours" onchange="toggle24Hours()">
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 12px; font-weight: 500;">24/7 Facility</span>
                            </label>
                        </div>
                        <div id="customHoursContainer">
                            <div class="language-selector">
                                <i class="fas fa-flag"></i>
                                <span class="language-link">English</span>
                            </div>
                            <textarea class="details-textarea" id="siteHours" placeholder="Monday - Friday: 9:00 AM - 6:00 PM&#10;Saturday: 9:00 AM - 4:00 PM&#10;Sunday: Closed" disabled></textarea>
                        </div>
                        <div class="details-actions" id="hoursActions" style="display: none;">
                            <button class="btn btn-primary" onclick="saveDetailsSection('hours')">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditMode('hours')">Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Contract Template -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">Rental Contract Template</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="toggleEditMode('contract')" id="editContractBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('contract')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="contractInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>This contract will be sent to customers during onboarding. Use HTML formatting. Variables: {FACILITY_NAME}, {CUSTOMER_NAME}, {UNIT_NUMBER}, {MONTHLY_RATE}, {ADMIN_FEE}, {INSURANCE_FEE}, {TAX_RATE}, {TOTAL_MONTHLY}</span>
                        </div>
                        <div class="language-selector">
                            <i class="fas fa-flag"></i>
                            <span class="language-link">English</span>
                        </div>
                        <div style="position: relative;">
                            <textarea class="details-textarea" id="contractTemplate" style="min-height: 400px; font-family: 'Courier New', monospace;" placeholder="<h1>Rental Agreement</h1>&#10;&#10;<p>This agreement is between <strong>{FACILITY_NAME}</strong> and <strong>{CUSTOMER_NAME}</strong>...</p>&#10;&#10;<h2>Terms and Conditions</h2>&#10;<ul>&#10;<li>Monthly rent: ${MONTHLY_RATE}</li>&#10;<li>Admin fee: ${ADMIN_FEE}</li>&#10;<li>Insurance: ${INSURANCE_FEE}</li>&#10;</ul>" disabled></textarea>
                            <div style="position: absolute; top: 8px; right: 8px;">
                                <button class="btn btn-sm btn-secondary" onclick="previewContract()" style="font-size: 12px; padding: 4px 8px;">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                        </div>
                        <div class="details-actions" id="contractActions" style="display: none;">
                            <button class="btn btn-primary" onclick="saveDetailsSection('contract')">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditMode('contract')">Cancel</button>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">Location</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="toggleEditMode('location')" id="editLocationBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('location')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="locationInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>Add latitude and longitude coordinates to show this site on the map view. To find latitude/longitude coordinates, find your site on Google Maps and right click the marker. The coordinates will appear at the top of the menu; clicking them will copy them to the clipboard.</span>
                        </div>
                        <div class="location-inputs">
                            <div class="form-group">
                                <label class="form-label">Latitude</label>
                                <input type="text" class="form-input" id="latitude" placeholder="e.g., 36.1627" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Longitude</label>
                                <input type="text" class="form-input" id="longitude" placeholder="e.g., -86.7816" disabled>
                            </div>
                        </div>
                        <div class="details-actions" id="locationActions" style="display: none;">
                            <button class="btn btn-primary" onclick="saveDetailsSection('location')">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditMode('location')">Cancel</button>
                        </div>
                    </div>

                    <!-- Submit Booking Text -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">Submit booking text</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="toggleEditMode('booking')" id="editBookingBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('booking')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="bookingInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>This content is displayed in the last step before submitting a move-in order. It's a good place to display legal information or tell the customer what to expect next.</span>
                        </div>
                        <div class="language-selector">
                            <i class="fas fa-flag"></i>
                            <span class="language-link">English</span>
                        </div>
                        <textarea class="details-textarea" id="submitBookingText" placeholder="Please review your order and click submit to reserve your unit." disabled></textarea>
                        <div class="details-actions" id="bookingActions" style="display: none;">
                            <button class="btn btn-primary" onclick="saveDetailsSection('booking')">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditMode('booking')">Cancel</button>
                        </div>
                    </div>

                    <!-- Unit Type Groups -->
                    <div class="details-section-card">
                        <div class="details-section-header">
                            <h3 class="details-section-title">Unit type groups</h3>
                            <div class="details-section-actions">
                                <button class="details-icon-btn" onclick="addUnitTypeGroup()">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="details-icon-btn" onclick="showInfo('unitGroups')">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                                <button class="details-icon-btn">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box" id="unitGroupsInfoBox">
                            <i class="fas fa-info-circle"></i>
                            <span>If you have many unit types, you can organise them into groups such as Small/Medium/Large, making it easier for the customer to find the right unit type for them.</span>
                        </div>
                        <div id="unitTypeGroupsList">
                            <div class="empty-state" style="padding: 20px; text-align: center; color: #6b7280;">No unit type groups configured</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Units Section -->
        <div id="units-section" class="section">
            <div class="sgc-table-header">
                <div class="filters">
                    <span class="filter">
                        <button type="button" class="btn btn-link">Status<span class="caret"></span></button>
                    </span>
                    <span class="filter">
                        <input type="text" class="form-control input-sm" placeholder="Search units..." id="unitSearch" oninput="loadUnits()" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </span>
            </div>
                <div class="btn-group" style="margin-right: -4px;">
                    <button type="button" class="btn btn-link" onclick="openBulkAddModal()" title="Bulk Add Units"><i class="far fa-plus"></i></button>
                    <button type="button" class="btn btn-link" onclick="openUnitModal()" title="Add Unit"><i class="far fa-plus"></i></button>
                    <button type="button" class="btn btn-link" onclick="loadUnits()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="table-container" style="margin-top: 0;">
                <div class="filter-bar" style="display: none;">
                    <select class="filter-select" id="unitStatusFilter" onchange="loadUnits()">
                        <option value="all">All Status</option>
                        <option value="Available">Available</option>
                        <option value="Occupied">Occupied</option>
                        <option value="Reserved">Reserved</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Unit Number</th>
                            <th>Size</th>
                            <th>Status</th>
                            <th>Customer</th>
                            <th>Monthly Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unitsTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading units...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="section">
            <div class="sgc-table-header">
                <div class="filters">
                    <span class="filter">
                        <button type="button" class="btn btn-link">Status<span class="caret"></span></button>
                    </span>
                    <span class="filter">
                        <input type="text" class="form-control input-sm" placeholder="Search customers..." id="customerSearch" oninput="loadCustomers()" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </span>
            </div>
                <div class="btn-group" style="margin-right: -4px;">
                    <button type="button" class="btn btn-link" onclick="syncGateAccess()" title="Sync Gate Access"><i class="fas fa-sync-alt"></i></button>
                    <button type="button" class="btn btn-link" onclick="openCustomerModal()" title="Add Customer"><i class="far fa-plus"></i></button>
                    <button type="button" class="btn btn-link" onclick="loadCustomers()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="table-container" style="margin-top: 0;">
                <div class="filter-bar" style="display: none;"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Unit</th>
                            <th>Gate Code</th>
                            <th>Status</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        <tr>
                            <td colspan="8" class="loading">Loading customers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Jobs Section -->
        <div id="jobs-section" class="section">
            <div class="tab-content" style="padding: 24px;">
                <h1 class="page-title" style="margin-bottom: 24px; color: #111827; font-size: 24px; font-weight: 600;">Jobs</h1>
                <div class="jobs-filter-bar">
                    <div class="filter-chips">
                        <div class="filter-chip active" id="stateFilterChip">
                            <span>State</span>
                            <i class="fas fa-caret-down"></i>
                            <button class="filter-chip-remove" onclick="removeFilter('state')"></button>
                        </div>
                        <div class="filter-chip active" id="typeFilterChip">
                            <span>Type: Move-In, Move-out, Transfer, Task, Lead</span>
                            <i class="fas fa-caret-down"></i>
                            <button class="filter-chip-remove" onclick="removeFilter('type')"></button>
                        </div>
                        <div class="filter-dropdown" onclick="toggleFilterDropdown('dates')">
                            <span>Dates</span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                        <div class="filter-dropdown" onclick="toggleFilterDropdown('labels')">
                            <span>Labels</span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Unit</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading jobs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sitemap Section -->
        <div id="sitemap-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1 class="page-title" style="margin: 0;">Sitemap</h1>
                <div>
                    <button class="btn btn-secondary" onclick="resetZoom()">Reset Zoom</button>
                    <button class="btn btn-primary" onclick="saveSitemap()">Save Sitemap</button>
                </div>
            </div>

            <div class="sitemap-container">
                <div class="sitemap-toolbar">
                    <button class="btn btn-sm btn-secondary" onclick="zoomIn()">+</button>
                    <button class="btn btn-sm btn-secondary" onclick="zoomOut()">-</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetZoom()">Reset</button>
                    <button class="btn btn-sm btn-primary" onclick="saveSitemap()">Save Sitemap</button>
                </div>
                <div id="sitemapCanvas" style="border: 1px solid var(--gray-300); border-radius: 8px; background: var(--gray-50);"></div>
            </div>
        </div>

        <!-- Invoices Section -->
        <div id="invoices-section" class="section">
            <!-- Overdue Alert -->
            <div id="invoicesOverdueAlert" style="display: none; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px 16px; margin-bottom: 16px; color: #991b1b;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="overdueUnitsCount">This site has 0 overdue units.</span>
            </div>
            
            <!-- Filters and Search -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 14px; color: #6b7280; font-weight: 500;">State:</span>
                    <button type="button" class="invoice-filter-btn" data-status="all" onclick="filterInvoices('all')" style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer;">All</button>
                    <button type="button" class="invoice-filter-btn" data-status="Draft" onclick="filterInvoices('Draft')" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; color: #f59e0b;">Draft</button>
                    <button type="button" class="invoice-filter-btn" data-status="Sent" onclick="filterInvoices('Sent')" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; color: #3b82f6;">Sent</button>
                    <button type="button" class="invoice-filter-btn" data-status="Paid" onclick="filterInvoices('Paid')" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; color: #059669;">Paid</button>
                    <button type="button" class="invoice-filter-btn" data-status="Failed" onclick="filterInvoices('Failed')" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; color: #dc2626;">Failed</button>
                    
                    <select class="invoice-filter-select" onchange="filterInvoicesByDate(this.value)" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; margin-left: 8px;">
                        <option value="">Dates</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="this_quarter">This Quarter</option>
                        <option value="this_year">This Year</option>
                    </select>
                    
                    <select class="invoice-filter-select" onchange="filterInvoicesByCustomer(this.value)" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                        <option value="">Customer</option>
                    </select>
                    
                    <select class="invoice-filter-select" onchange="filterInvoicesByLabel(this.value)" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                        <option value="">Labels</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 13px;"></i>
                        <input type="text" id="invoiceSearchInput" placeholder="Enter invoice ID" oninput="filterInvoicesBySearch(this.value)" style="padding: 6px 12px 6px 32px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; width: 180px;">
                    </div>
                    <button type="button" class="btn-icon" title="Select multiple"><i class="far fa-check-square"></i></button>
                    <button type="button" class="btn-icon" onclick="loadInvoices()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                    <button type="button" class="btn-icon" title="More options"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </div>
            
            <!-- Invoices List -->
            <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div id="invoicesListContainer" style="padding: 0;">
                    <!-- Invoices will be rendered here -->
                    <div style="padding: 40px; text-align: center; color: #6b7280;">
                        <div class="loading">Loading invoices...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users Section -->
        <div id="users-section" class="section">
            <div class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h1 class="page-title">Facility Users</h1>
                    <button class="btn btn-primary" onclick="openInviteUserModal()">
                        <i class="fas fa-user-plus"></i> Invite User
                    </button>
                </div>
                <div id="facilityUsersContainer" style="background: white; border-radius: 8px; padding: 24px;">
                    <div class="loading">Loading users...</div>
                </div>
            </div>
        </div>
        
        <!-- Invite User Modal -->
        <div id="inviteUserModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Invite User</h2>
                    <button class="close-btn" onclick="closeInviteUserModal()">&times;</button>
                </div>
                <form id="inviteUserForm" onsubmit="sendInvite(event)">
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-input" id="inviteEmail" name="email" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-input" id="inviteRole" name="role" required>
                            <option value="Manager">Manager</option>
                            <option value="Employee">Employee</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeInviteUserModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Invite</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Invoice Detail Modal (will be shown when clicking invoice) -->
        <div id="invoiceDetailModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title" id="invoiceDetailTitle">Invoice Details</h2>
                    <button class="close-btn" onclick="closeInvoiceDetail()">&times;</button>
                </div>
                <div class="modal-body" id="invoiceDetailContent" style="padding: 0 32px 32px 32px;">
                    <!-- Invoice details will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Unit Detail Modal - Storeganise Style -->
        <div id="unitDetailModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto; padding: 0;">
                <!-- Close button in top right -->
                <button class="close-btn" onclick="closeUnitDetail()" style="position: absolute; top: 20px; right: 20px; z-index: 10;">&times;</button>
                
                <!-- Header with breadcrumb -->
                <div style="background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 20px 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;" id="unitDetailBreadcrumb">
                            <span id="facilityNameBreadcrumb"></span> : Units : <span id="unitNumberBreadcrumb"></span>
                        </h2>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-icon" title="Bookmark"><i class="fas fa-bookmark"></i></button>
                            <button class="btn-icon" title="More options"><i class="fas fa-ellipsis-v"></i></button>
                            <button class="btn-icon" title="Edit"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Main content layout: Sidebar + Main area -->
                <div style="display: flex; gap: 0; min-height: calc(95vh - 100px); background: #f9fafb;">
                    <!-- Left Sidebar -->
                    <div id="unitDetailSidebar" style="width: 320px; background: #ffffff; border-right: 1px solid #e5e7eb; padding: 24px; min-height: 100%;">
                        <!-- Unit card will be loaded here -->
                        <div class="loading">Loading unit...</div>
                    </div>
                    
                    <!-- Right Main Content -->
                    <div style="flex: 1; padding: 24px; background: #f9fafb;">
                        <!-- Tabs -->
                        <div style="background: #ffffff; border-radius: 8px; padding: 0; margin-bottom: 24px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; border-bottom: 1px solid #e5e7eb;">
                                <button class="unit-detail-tab active" onclick="switchUnitDetailTab('overview')" data-tab="overview" style="border-radius: 8px 0 0 0;">
                                    <i class="fas fa-chart-line"></i> Overview
                                </button>
                                <button class="unit-detail-tab" onclick="switchUnitDetailTab('details')" data-tab="details">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="unit-detail-tab" onclick="switchUnitDetailTab('previous')" data-tab="previous">
                                    <i class="fas fa-history"></i> Previous rentals
                                </button>
                                <button class="unit-detail-tab" onclick="switchUnitDetailTab('history')" data-tab="history">
                                    <i class="fas fa-clock"></i> History
                                </button>
                            </div>
                            
                            <!-- Tab Content -->
                            <div id="unitDetailContent" style="padding: 24px;">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule Move-In Modal -->
        <div id="scheduleMoveInModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Schedule move-in</h2>
                    <button class="close-btn" onclick="closeScheduleMoveInModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="scheduleMoveInForm" onsubmit="saveScheduleMoveIn(event)">
                        <input type="hidden" id="scheduleMoveInUnitId">
                        
                        <div class="form-group">
                            <label class="form-label">Customer *</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-input" id="scheduleMoveInCustomer" placeholder="Search customer or enter email" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="selectScheduleMoveInCustomer()" style="white-space: nowrap;">
                                    <i class="fas fa-caret-down"></i>
                                </button>
                                <button type="button" class="btn btn-primary" onclick="addNewCustomerForMoveIn()" title="Add new customer">
                                    <i class="fas fa-plus"></i>
                                </button>
                        </div>
                            <input type="hidden" id="scheduleMoveInCustomerId">
                        </div>
                        
                        <div class="form-group" id="scheduleMoveInBillingInfo" style="display: none;">
                            <label class="form-label">Billing info:</label>
                            <a href="#" onclick="return false;" style="color: #2563eb; text-decoration: underline;" id="scheduleMoveInAddCard">Add card</a>
                            <div id="scheduleMoveInCardInfo" style="margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span id="scheduleMoveInCardNumber">   1234</span>
                                    <button type="button" class="btn-icon" onclick="removeScheduleMoveInCard()"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Move-in date *</label>
                            <input type="date" class="form-input" id="scheduleMoveInDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Deposit *</label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">$</span>
                                <input type="number" class="form-input" id="scheduleMoveInDeposit" step="0.01" min="0" value="100" required style="padding-left: 28px;">
                        </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Price *</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div style="position: relative; flex: 1;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">$</span>
                                    <input type="number" class="form-input" id="scheduleMoveInPrice" step="0.01" min="0" required style="padding-left: 28px;">
                        </div>
                                <button type="button" class="btn-icon" onclick="resetScheduleMoveInPrice()" title="Reset to default"><i class="fas fa-pencil-alt"></i></button>
                            </div>
                            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">You can set a custom price by inputting the value here.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prepayment</label>
                            <select class="form-input" id="scheduleMoveInPrepayment">
                                <option value="none">No pre-payment</option>
                                <option value="1month">1 month</option>
                                <option value="3months">3 months</option>
                                <option value="6months">6 months</option>
                                <option value="12months">12 months</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="number" class="form-input" id="scheduleMoveInPrepaymentCustom" min="1" placeholder="Enter months" style="margin-top: 8px; display: none;">
                            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">You can set a custom number of periods by inputting the value here.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Promo code</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="form-input" id="scheduleMoveInPromoCode" placeholder="Enter promo code" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="selectPromoCode()">
                                    <i class="fas fa-caret-down"></i>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="createCustomPromoCode()">Custom... +</button>
                            </div>
                        </div>
                        
                        <div class="form-actions" style="margin-top: 32px;">
                            <button type="button" class="btn btn-secondary" onclick="closeScheduleMoveInModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Schedule move-in</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Record Payment Modal -->
        <div id="recordPaymentModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Record Payment</h2>
                    <button class="close-btn" onclick="closeRecordPaymentModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="recordPaymentForm" onsubmit="saveRecordedPayment(event)">
                        <input type="hidden" id="recordPaymentInvoiceId">
                        <div class="form-group">
                            <label class="form-label">Amount *</label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">$</span>
                                <input type="number" class="form-input" id="recordPaymentAmount" step="0.01" min="0" required style="padding-left: 28px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method *</label>
                            <select class="form-input" id="recordPaymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Cash">Cash</option>
                                <option value="Check">Check</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Stripe">Stripe</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction ID</label>
                            <input type="text" class="form-input" id="recordPaymentTransactionId" placeholder="Optional transaction reference">
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeRecordPaymentModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Record Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Unit Types Section -->
        <div id="unit-types-section" class="section">
            <div class="sgc-table-header">
                <div class="filters"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-link" onclick="openUnitTypeModal()" title="Add Unit Type"><i class="far fa-plus"></i></button>
                    <button type="button" class="btn btn-link" onclick="loadUnitTypes()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        </div>
            <div class="tab-content" style="padding: 20px;">
            <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Default Rate</th>
                                <th>Units</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unitTypesTableBody">
                            <tr>
                                <td colspan="5" class="loading">Loading unit types...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                        </div>
                        </div>

        <!-- Products Section -->
        <div id="products-section" class="section">
            <div class="sgc-table-header">
                <div class="filters"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-link" onclick="openProductModal()" title="Add Product"><i class="far fa-plus"></i></button>
                    <button type="button" class="btn btn-link" onclick="loadProducts()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        </div>
            <div class="tab-content" style="padding: 20px;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="5" class="loading">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add-ons Section -->
        <div id="addons-section" class="section">
            <div class="sgc-table-header">
                <div class="filters"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-link" onclick="loadAddons()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="tab-content" style="padding: 20px;">
                <div class="table-container">
                    <div style="padding: 40px; text-align: center; color: #999;">
                        <i class="far fa-cubes" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <p>No add-ons available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="section">
            <div class="sgc-table-header">
                <div class="filters">
                    <span class="filter">
                        <button type="button" class="btn btn-link">Dates<span class="caret"></span></button>
                    </span>
                    <span class="filter">
                        <button type="button" class="btn btn-link">Type<span class="caret"></span></button>
                    </span>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-link" onclick="loadHistory()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="tab-content" style="padding: 20px;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="4" class="loading">Loading history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Section -->
        <div id="settings-section" class="section">
            <div class="tab-content" style="padding: 20px;">
                <div class="css-r0cp6o" style="margin-bottom: 20px;">
                    <div class="header" style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">
                        <div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="title" id="advanced" style="margin: 0; font-size: 18px; font-weight: 600;">
                                <a href="#advanced" style="color: #333; text-decoration: none;">Advanced</a>
                            </h3>
                            <div class="extra">
                                <a class="btn btn-link hidden-print" href="#" target="_blank"><i class="far fa-fw fa-question-circle" title="Help"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="content">
                        <form id="settingsForm" class="form-horizontal">
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px;">
                                <label for="settingSiteCode" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Site code</span>
                            </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input name="code" class="form-control" id="settingSiteCode" value="" style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    <span class="help-block text-muted" style="margin-top: 5px; font-size: 12px; color: #999;">Short, simple identifier e.g. <code>downtown</code>. NOTE: Changing this can impact the connection between APIs and websites.</span>
                        </div>
                            </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingHidePortal" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Hide in Customer Portal?</span>
                            </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="checkbox" name="hidden" class="form-control" id="settingHidePortal" style="width: auto;">
                                    <span class="help-block text-muted" style="margin-top: 5px; font-size: 12px; color: #999;">If checked, the Site will be hidden in the Customer Portal. If not checked, it will be shown.</span>
                        </div>
                        </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingEnableBooking" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Enable unit booking</span>
                                </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="checkbox" name="enableUnitBooking" class="form-control" id="settingEnableBooking" style="width: auto;">
                                    <span class="help-block text-muted" style="margin-top: 5px; font-size: 12px; color: #999;">If checked, display the sitemap in the Customer Portal and allow booking specific units</span>
                                </div>
                            </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingFacilityName" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Facility Name</span>
                                </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="text" class="form-control" id="settingFacilityName" name="Facility_Name" required style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingAddress" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Address</span>
                                </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="text" class="form-control" id="settingAddress" name="Address" style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingPhone" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Phone</span>
                                </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="tel" class="form-control" id="settingPhone" name="Phone" style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="form-group form-horizontal clearfix" style="margin-bottom: 20px; clear: both;">
                                <label for="settingEmail" class="control-label col-sm-3" style="float: left; width: 25%; padding-top: 7px;">
                                    <span>Email</span>
                                </label>
                                <div class="col-sm-9" style="float: left; width: 75%;">
                                    <input type="email" class="form-control" id="settingEmail" name="Email" style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <button class="btn btn-primary pull-right" type="submit" style="float: right; margin-top: 20px;">
                                <span>Save</span>
                            </button>
                        </form>

                        <!-- Open API Access Section -->
                        <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #e5e7eb;">
                            <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 8px;">Open API access</h2>
                            <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">
                                Use your facility API key to connect gate systems, door locks, call centers, and other vendors.
                                Treat this key like a password  anyone with it can read data for this facility.
                            </p>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                                <input type="text" id="apiKeyDisplay" class="form-control" readonly
                                       placeholder="No API key generated yet"
                                       style="flex: 1; font-family: monospace; font-size: 13px; background: #f9fafb;">
                                <button type="button" class="btn btn-secondary" onclick="copyApiKey()" id="copyApiKeyBtn" disabled>
                                    Copy
                                </button>
                                <button type="button" class="btn btn-primary" onclick="generateApiKey()" id="generateApiKeyBtn">
                                    Generate API key
                                </button>
                            </div>
                            <p style="font-size: 12px; color: #9ca3af; margin: 0;">
                                Share this key only with trusted vendors. You can regenerate it at any time to revoke old access.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Meridian Storage Solutions Corporation Subscription Section -->
                    <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #e5e7eb;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 24px;">Meridian Storage Solutions Corporation Subscription</h2>
                        
                        <div id="subscriptionCard" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                            <div id="subscriptionDetails" style="margin-bottom: 24px;">
                                <!-- Promo Code Banner -->
                                <div id="promoCodeBanner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; padding: 20px; margin-bottom: 24px; color: white;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 24px;"></span>
                                        <div>
                                            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: white;">Promo Code Applied!</h3>
                                            <p id="promoCodeText" style="margin: 4px 0 0 0; font-size: 14px; opacity: 0.95;">You have free software until <strong id="promoEndDate">Loading...</strong></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                                    <div>
                                        <h3 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Subscription Status</h3>
                                        <div id="subscriptionStatusBadge" style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 14px; font-weight: 600; background: #d1fae5; color: #065f46;">
                                            Loading...
                                        </div>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Monthly Fee</h3>
                                        <div id="subscriptionMonthlyFee" style="font-size: 20px; font-weight: 700; color: #111827;">
                                            $0.00
                                        </div>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Next Payment Due</h3>
                                        <div id="subscriptionNextPayment" style="font-size: 16px; font-weight: 600; color: #111827;">
                                            Loading...
                                        </div>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Subscription Plan</h3>
                                        <div id="subscriptionPlan" style="font-size: 16px; font-weight: 600; color: #111827;">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                                <button id="cancelSubscriptionBtn" class="btn btn-danger" onclick="confirmCancelSubscription()" style="display: none;">
                                    <i class="fas fa-times-circle"></i> Cancel Subscription
                                </button>
                                <button id="reactivateSubscriptionBtn" class="btn btn-primary" onclick="reactivateSubscription()" style="display: none;">
                                    <i class="fas fa-check-circle"></i> Reactivate Subscription
                                </button>
                            </div>
                        </div>
                        
                        <!-- Payment History -->
                        <div id="paymentHistoryCard" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 20px;">Payment History</h3>
                            <div id="paymentHistoryTable" style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #e5e7eb;">
                                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Date</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Invoice ID</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Amount</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Status</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentHistoryBody">
                                        <tr>
                                            <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">Loading payment history...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QuickBooks Integration Section -->
                    <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #e5e7eb;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 24px;">QuickBooks Integration</h2>
                        
                        <div id="qbStatusCard" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 4px 0;">Connection Status</h3>
                                    <p id="qbStatusText" style="color: #6b7280; margin: 0; font-size: 14px;">Checking connection...</p>
                                </div>
                                <div id="qbStatusBadge" style="padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                    <span id="qbStatusLabel">Not Connected</span>
                                </div>
                            </div>
                            <div id="qbConnectionActions" style="display: flex; gap: 12px;">
                                <button id="qbConnectBtn" class="btn btn-primary" onclick="connectQuickBooks()" style="display: none;">
                                    <i class="fas fa-plug"></i> Connect QuickBooks
                                </button>
                                <button id="qbDisconnectBtn" class="btn btn-secondary" onclick="disconnectQuickBooks()" style="display: none;">
                                    <i class="fas fa-unlink"></i> Disconnect
                                </button>
                                <button id="qbRefreshBtn" class="btn btn-secondary" onclick="refreshQuickBooksToken()" style="display: none;">
                                    <i class="fas fa-sync-alt"></i> Refresh Token
                                </button>
                            </div>
                        </div>
                        
                        <div id="qbSettingsCard" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-bottom: 24px; display: none;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Sync Settings</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="qbSyncCustomers" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #374151;">Automatically sync customers to QuickBooks</span>
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="qbSyncInvoices" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #374151;">Automatically sync invoices to QuickBooks</span>
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="qbSyncPayments" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #374151;">Automatically sync payments to QuickBooks</span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">
                        <div class="form-group">
                                    <label class="form-label">Income Account</label>
                                    <input type="text" class="form-input" id="qbIncomeAccount" placeholder="e.g., Storage Rental Income">
                                    <small style="color: #6b7280; font-size: 12px;">QuickBooks account for rental income</small>
                        </div>
                                
                        <div class="form-group">
                                    <label class="form-label">Payment Method</label>
                                    <input type="text" class="form-input" id="qbPaymentMethod" placeholder="e.g., Credit Card">
                                    <small style="color: #6b7280; font-size: 12px;">Default payment method in QuickBooks</small>
                        </div>
                                
                        <div class="form-group">
                                    <label class="form-label">Service Item</label>
                                    <input type="text" class="form-input" id="qbItemService" placeholder="e.g., Storage Unit Rental">
                                    <small style="color: #6b7280; font-size: 12px;">QuickBooks service item for invoices</small>
                        </div>
                                
                        <div class="form-group">
                                    <label class="form-label">Class (Optional)</label>
                                    <input type="text" class="form-input" id="qbClass" placeholder="e.g., Facility A">
                                    <small style="color: #6b7280; font-size: 12px;">QuickBooks class for this facility</small>
                        </div>
                        </div>
                            
                            <div style="margin-top: 24px; display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="saveQuickBooksSettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                </div>
            </div>
                        
                        <div id="qbSyncCard" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; display: none;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Manual Sync</h3>
                            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Manually sync data to QuickBooks. This will sync all customers, invoices, and payments.</p>
                            
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="syncQBData('customers')">
                                    <i class="fas fa-users"></i> Sync Customers
                                </button>
                                <button class="btn btn-secondary" onclick="syncQBData('invoices')">
                                    <i class="fas fa-file-invoice"></i> Sync Invoices
                                </button>
                                <button class="btn btn-secondary" onclick="syncQBData('payments')">
                                    <i class="fas fa-dollar-sign"></i> Sync Payments
                                </button>
                                <button class="btn btn-primary" onclick="syncQBData('all')">
                                    <i class="fas fa-sync"></i> Sync All
                                </button>
                            </div>
                            
                            <div id="qbSyncStatus" style="margin-top: 20px; padding: 12px; border-radius: 6px; display: none;"></div>
                        </div>
                        
                        <div id="qbLastSync" style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 6px; display: none;">
                            <p style="margin: 0; font-size: 13px; color: #6b7280;">
                                <i class="fas fa-clock"></i> Last sync: <span id="qbLastSyncTime">Never</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unit Modal -->
    <div id="unitModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="unitModalTitle">Add Unit</h2>
                <button class="close-btn" onclick="closeUnitModal()">&times;</button>
            </div>
            <form id="unitForm" onsubmit="saveUnit(event)">
                <input type="hidden" id="unitId" name="unitId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">Unit Number *</label>
                        <input type="text" class="form-input" id="unitNumber" name="Unit_Number" placeholder="e.g., 101" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Size *</label>
                        <select class="form-input" id="unitSize" name="Size" required>
                            <option value="">Select Size</option>
                            <option value="5x5">5x5</option>
                            <option value="5x10">5x10</option>
                            <option value="10x10">10x10</option>
                            <option value="10x15">10x15</option>
                            <option value="10x20">10x20</option>
                            <option value="10x30">10x30</option>
                            <option value="12x24">12x24</option>
                            <option value="12x30">12x30</option>
                            <option value="12x40">12x40</option>
                            <option value="20x20">20x20</option>
                            <option value="20x40">20x40</option>
                            <option value="Custom">Custom Size</option>
                        </select>
                        <input type="text" class="form-input" id="unitSizeCustom" name="SizeCustom" placeholder="Enter custom size" style="margin-top: 8px; display: none;">
                </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">Monthly Rate *</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">$</span>
                            <input type="number" class="form-input" id="unitRate" name="Monthly_Rate" step="0.01" min="0" placeholder="0.00" required style="padding-left: 28px;">
                        </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select class="form-input" id="unitStatus" name="Status" required>
                        <option value="Available">Available</option>
                        <option value="Occupied">Occupied</option>
                        <option value="Reserved">Reserved</option>
                    </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Customer (if occupied)</label>
                    <select class="form-input" id="unitCustomer" name="Customer_ID">
                        <option value="">Select Customer</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUnitModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Unit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Add Units Modal -->
    <div id="bulkAddModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Bulk Add Units</h2>
                <button class="close-btn" onclick="closeBulkAddModal()">&times;</button>
            </div>
            <form id="bulkAddForm" onsubmit="saveBulkUnits(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Starting Unit Number *</label>
                        <input type="text" class="form-input" id="bulkStartNumber" name="startNumber" placeholder="e.g., 101" required oninput="updateBulkPreview()">
                        <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">First unit number in sequence</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Units *</label>
                        <input type="number" class="form-input" id="bulkCount" name="count" min="1" max="200" value="10" required oninput="updateBulkPreview()">
                        <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">Max 200 units at once</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Size *</label>
                        <select class="form-input" id="bulkSize" name="size" required>
                            <option value="">Select Size</option>
                            <option value="5x5">5x5</option>
                            <option value="5x10">5x10</option>
                            <option value="10x10">10x10</option>
                            <option value="10x15">10x15</option>
                            <option value="10x20">10x20</option>
                            <option value="10x30">10x30</option>
                            <option value="12x24">12x24</option>
                            <option value="12x30">12x30</option>
                            <option value="12x40">12x40</option>
                            <option value="20x20">20x20</option>
                            <option value="20x40">20x40</option>
                            <option value="Custom">Custom Size</option>
                        </select>
                        <input type="text" class="form-input" id="bulkSizeCustom" name="sizeCustom" placeholder="Enter custom size" style="margin-top: 8px; display: none;" oninput="updateCustomSize()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Rate *</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-weight: 600;">$</span>
                            <input type="number" class="form-input" id="bulkRate" name="rate" step="0.01" min="0" placeholder="0.00" required style="padding-left: 28px;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select class="form-input" id="bulkStatus" name="status" required>
                        <option value="Available">Available</option>
                        <option value="Reserved">Reserved</option>
                        <option value="Occupied">Occupied</option>
                    </select>
                </div>
                
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #3b82f6;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <strong style="color: #1e40af; font-size: 16px;">Preview</strong>
                    </div>
                    <div style="color: #1e3a8a; line-height: 1.8;">
                        <div>This will create <strong style="color: #3b82f6; font-size: 18px;" id="bulkPreview">10</strong> units</div>
                        <div>Starting from: <strong style="color: #3b82f6;" id="bulkPreviewStart">101</strong></div>
                        <div>Ending at: <strong style="color: #3b82f6;" id="bulkPreviewEnd">110</strong></div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #93c5fd;">
                            All units will be: <strong id="bulkPreviewSize">-</strong> at <strong id="bulkPreviewRate">$-</strong>/month
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBulkAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="bulkSubmitText">Create <span id="bulkSubmitCount">10</span> Units</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="customerModalTitle">Add Customer</h2>
                <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
            </div>
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <input type="hidden" id="customerId" name="customerId">
                <div class="form-group">
                    <label class="form-label">First Name *</label>
                    <input type="text" class="form-input" id="customerFirstName" name="First_Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name *</label>
                    <input type="text" class="form-input" id="customerLastName" name="Last_Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" id="customerEmail" name="Email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="customerPhone" name="Phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Unit Number</label>
                    <input type="text" class="form-input" id="customerUnit" name="Unit_Number">
                </div>
                <div class="form-group">
                    <label class="form-label">Gate Code</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" class="form-input" id="customerGateCode" name="Gate_Code" placeholder="Auto-generated if left blank" maxlength="4" pattern="[0-9]{4}" style="font-family: monospace; font-size: 16px; letter-spacing: 4px; text-align: center;">
                        <button type="button" class="btn btn-secondary" onclick="generateRandomGateCode()" style="white-space: nowrap;"> Generate</button>
                    </div>
                    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">Leave blank to auto-generate a unique 4-digit code</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby8_MUFwM7Cwvek9MPxO9K_q4Qsbbj6PBl53eama3j6w0gzyYyj4lCUFPyZ9mvDNxkC/exec';
        let currentFacilityId = null;
        let occupancyChart = null;
        let currentChartType = 'pie';
        let chartData = null;
        let sitemapStage = null;
        let sitemapLayer = null;
        let sitemapTransformer = null;
        let unitsData = [];
        let customersData = [];

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            // Get user info from localStorage or try to get from API
            let userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            
            // If no user info, try to get from API (for web app deployment)
            if (!userInfo.User_ID && !userInfo.userId && !userInfo.email) {
                try {
                    const response = await fetch(`${API_URL}?action=getUserInfo`);
                    const result = await response.json();
                    console.log('getUserInfo response:', result);
                    if (result.success && result.userInfo) {
                        userInfo = result.userInfo;
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    } else {
                        console.warn('getUserInfo failed or returned no user:', result);
                    }
                } catch (error) {
                    console.error('Error getting user info:', error);
                }
            }
            
            // Check role - be more flexible with role checking
            const role = userInfo.Role || userInfo.role || '';
            const roleLower = role.toLowerCase();
            
            console.log('User info:', userInfo);
            console.log('User role:', role, 'Lowercase:', roleLower);
            
            // Allow manager or owner, or if no role set (for testing/development)
            if (role && roleLower !== 'manager' && roleLower !== 'owner') {
                const errorMsg = 'Access denied. Manager privileges required.\n\n' +
                    'Your role: ' + (role || 'Not set') + '\n' +
                    'Required: manager or owner\n\n' +
                    'Please contact support if you believe this is an error.';
                console.error(errorMsg);
                alert(errorMsg);
                // For development: allow access but show warning
                showToast('Warning: Access granted for testing. Role: ' + role, 'error');
            } else if (!role) {
                console.warn('No role found in userInfo. Allowing access for testing.');
                showToast('Warning: No role set. Allowing access for testing.', 'error');
            }

            const firstName = userInfo.First_Name || userInfo.firstName || '';
            const lastName = userInfo.Last_Name || userInfo.lastName || '';
            document.getElementById('userName').textContent = `${firstName} ${lastName}`.trim() || 'manager';
            
            const userId = userInfo.User_ID || userInfo.userId;
            const facilityId = userInfo.Facility_ID || userInfo.facilityId;
            
            if (userId) {
                await loadManagerSites({ User_ID: userId, userId: userId });
            } else if (facilityId) {
                // If no userId but have facilityId, use that directly
                console.warn('No userId found, using facilityId directly:', facilityId);
                currentFacilityId = facilityId;
                const switcher = document.getElementById('siteSwitcher');
                if (switcher) {
                    switcher.innerHTML = `<option value="${facilityId}">Facility ${facilityId}</option>`;
                    switcher.onchange = (e) => {
                    currentFacilityId = e.target.value;
                    loadDashboard();
                };
                }
                await loadDashboard();
            } else {
                // Try to get facility from getAllFacilities (for testing)
                console.warn('No userId or facilityId found. Trying to load first available facility...');
                try {
                    const response = await fetch(`${API_URL}?action=getAllFacilities`);
                    const result = await response.json();
                    if (result.success && result.facilities && result.facilities.length > 0) {
                        currentFacilityId = result.facilities[0].Facility_ID;
                        const switcher = document.getElementById('siteSwitcher');
                        if (switcher) {
                        switcher.innerHTML = '';
                        result.facilities.forEach(facility => {
                            const option = document.createElement('option');
                            option.value = facility.Facility_ID;
                            option.textContent = facility.Facility_Name || facility.Facility_ID;
                            switcher.appendChild(option);
                        });
                        switcher.value = currentFacilityId;
                        switcher.onchange = (e) => {
                            currentFacilityId = e.target.value;
                            loadDashboard();
                        };
                        } else {
                            // Update facility name if switcher doesn't exist
                            const facilityNameEl = document.getElementById('facilityName');
                            if (facilityNameEl) {
                                facilityNameEl.textContent = result.facilities[0].Facility_Name || 'Facility';
                            }
                        }
                        await loadDashboard();
                        showToast('Loaded first available facility for testing', 'error');
                    } else {
                        showToast('Error: No facilities found. Please set up a facility first.', 'error');
                    }
                } catch (error) {
                    console.error('Error loading facilities:', error);
                    showToast('Error: Could not load facilities. Please check your setup.', 'error');
                }
            }
        });

        async function loadManagerSites(userInfo) {
            try {
                const userId = userInfo.User_ID || userInfo.userId;
                if (!userId) {
                    console.error('No user ID found');
                    return;
                }
                
                const response = await fetch(`${API_URL}?action=getManagerSites&userId=${userId}`);
                const result = await response.json();
                
                if (result.success && result.sites) {
                    const switcher = document.getElementById('siteSwitcher');
                    if (!switcher) {
                        console.warn('siteSwitcher element not found. Creating facility name display instead.');
                        // Update facility name if element exists
                        const facilityNameEl = document.getElementById('facilityName');
                        if (facilityNameEl && result.sites.length > 0) {
                            facilityNameEl.textContent = result.sites[0].Facility_Name || 'Facility';
                            currentFacilityId = result.sites[0].Facility_ID;
                            await loadDashboard();
                        }
                        return;
                    }
                    
                    switcher.innerHTML = '';
                    
                    result.sites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.Facility_ID;
                        option.textContent = site.Facility_Name;
                        switcher.appendChild(option);
                    });
                    
                    if (result.sites.length > 0) {
                        currentFacilityId = result.sites[0].Facility_ID;
                        switcher.value = currentFacilityId;
                        switcher.onchange = (e) => {
                            currentFacilityId = e.target.value;
                            loadDashboard();
                        };
                    }
                }
            } catch (error) {
                console.error('Error loading sites:', error);
            }
        }

        async function loadDashboard() {
            if (!currentFacilityId) return;
            
            await Promise.all([
                loadOverview(),
                loadUnits(),
                loadCustomers(),
                loadSettings()
            ]);
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.list-group-item').forEach(n => n.classList.remove('active'));
            
            // Show selected section
            const section = document.getElementById(sectionName + '-section');
            console.log('showSection:', sectionName, 'Found section:', section);
            if (section) {
                section.classList.add('active');
                console.log('Section activated:', section.id, 'Has active class:', section.classList.contains('active'));
            } else {
                console.error('Section not found:', sectionName + '-section');
            }
            
            // Activate nav item
            const navItems = document.querySelectorAll('.list-group-item');
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(sectionName)) {
                    item.classList.add('active');
                }
            });
            
            // Load section-specific data
            if (sectionName === 'sitemap') {
                setTimeout(() => initSitemap(), 100);
            } else if (sectionName === 'units') {
                loadUnits();
            } else if (sectionName === 'customers') {
                loadCustomers();
            } else if (sectionName === 'settings') {
                loadSettings();
            } else if (sectionName === 'details') {
                loadFacilityDetails();
            } else if (sectionName === 'jobs') {
                loadJobs();
            } else if (sectionName === 'invoices') {
                loadInvoices();
            } else if (sectionName === 'unit-types') {
                loadUnitTypes();
            } else if (sectionName === 'products') {
                loadProducts();
            } else if (sectionName === 'addons') {
                loadAddons();
            } else if (sectionName === 'history') {
                loadHistory();
            } else if (sectionName === 'users') {
                loadFacilityUsers();
            }
        }
        
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('open');
        }
        
        function toggleMobileMenu() {
            const collapse = document.querySelector('.navbar-collapse');
            collapse.classList.toggle('collapse');
        }
        
        function showTopNav(nav) {
            // Update active state in navigation
            document.querySelectorAll('.navbar-nav li a').forEach(a => a.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find and activate the clicked nav item
                const navLinks = document.querySelectorAll('.navbar-nav li a');
                navLinks.forEach(link => {
                    if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${nav}'`)) {
                        link.classList.add('active');
                    }
                });
            }
            
            // Hide all sections first
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            
            // Show appropriate section based on nav
            switch(nav) {
                case 'analytics':
                    // Show analytics section (will embed analytics web app)
                    showAnalyticsSection();
                    break;
                case 'sites':
                    // Show default dashboard (overview section)
                    showSection('overview');
                    break;
                case 'users':
                    // Show users management section
                    showSection('users');
                    loadFacilityUsers();
                    break;
                case 'invoices':
                    // Show invoices section
                    showSection('invoices');
                    loadInvoices();
                    break;
                default:
                    showSection('overview');
            }
        }
        
        function showAnalyticsSection() {
            // Create analytics section if it doesn't exist
            let analyticsSection = document.getElementById('analytics-section');
            if (!analyticsSection) {
                analyticsSection = document.createElement('div');
                analyticsSection.id = 'analytics-section';
                analyticsSection.className = 'section';
                analyticsSection.innerHTML = `
                    <div class="tab-content">
                        <h1 class="page-title">Analytics</h1>
                        <div id="analyticsContainer" style="background: white; border-radius: 8px; padding: 24px; min-height: 600px;">
                            <div class="loading">Loading analytics...</div>
                        </div>
                    </div>
                `;
                document.querySelector('.main-content').appendChild(analyticsSection);
            }
            
            analyticsSection.classList.add('active');
            analyticsSection.style.display = 'block';
            
            // Load analytics (will embed web app or show analytics)
            loadAnalytics();
        }
        
        async function loadAnalytics() {
            try {
                const container = document.getElementById('analyticsContainer');
                if (!container) return;
                
                // For now, show placeholder - will be replaced with embedded analytics web app
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-chart-line" style="font-size: 64px; color: #9ca3af; margin-bottom: 20px;"></i>
                        <h2 style="color: #374151; margin-bottom: 12px;">Analytics Dashboard</h2>
                        <p style="color: #6b7280; margin-bottom: 32px;">Analytics system coming soon. This will include:</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 800px; margin: 0 auto;">
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <i class="fas fa-chart-bar" style="font-size: 32px; color: #2563eb; margin-bottom: 12px;"></i>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Occupancy Trends</h3>
                                <p style="font-size: 14px; color: #6b7280;">Track occupancy rates over time</p>
                            </div>
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <i class="fas fa-dollar-sign" style="font-size: 32px; color: #10b981; margin-bottom: 12px;"></i>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Revenue Analytics</h3>
                                <p style="font-size: 14px; color: #6b7280;">Monitor revenue and trends</p>
                            </div>
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <i class="fas fa-sync-alt" style="font-size: 32px; color: #f59e0b; margin-bottom: 12px;"></i>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Move-ins/Move-outs</h3>
                                <p style="font-size: 14px; color: #6b7280;">Track unit turnover</p>
                            </div>
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <i class="fas fa-link" style="font-size: 32px; color: #8b5cf6; margin-bottom: 12px;"></i>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Integrations</h3>
                                <p style="font-size: 14px; color: #6b7280;">Google Analytics, Facebook, etc.</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        async function loadFacilityUsers() {
            try {
                const container = document.getElementById('facilityUsersContainer');
                if (!container) {
                    // Create users section if it doesn't exist
                    const usersSection = document.getElementById('users-section');
                    if (usersSection) {
                        usersSection.innerHTML = `
                            <div class="tab-content">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <h1 class="page-title">Facility Users</h1>
                                    <button class="btn btn-primary" onclick="openInviteUserModal()">
                                        <i class="fas fa-user-plus"></i> Invite User
                                    </button>
                                </div>
                                <div id="facilityUsersContainer" style="background: white; border-radius: 8px; padding: 24px;">
                                    <div class="loading">Loading users...</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                const response = await fetch(`${API_URL}?action=getFacilityUsers&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success && result.users) {
                    const container = document.getElementById('facilityUsersContainer');
                    if (container) {
                        if (result.users.length === 0) {
                            container.innerHTML = `
                                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                                    <i class="fas fa-users" style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;"></i>
                                    <p style="font-size: 16px; margin-bottom: 24px;">No users have been invited yet.</p>
                                    <button class="btn btn-primary" onclick="openInviteUserModal()">
                                        <i class="fas fa-user-plus"></i> Invite First User
                                    </button>
                                </div>
                            `;
                        } else {
                            container.innerHTML = `
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${result.users.map(user => `
                                                <tr>
                                                    <td><strong>${(user.First_Name || '')} ${(user.Last_Name || '')}</strong></td>
                                                    <td>${user.Email || ''}</td>
                                                    <td><span class="status-badge status-${(user.Role || 'Manager').toLowerCase()}">${user.Role || 'Manager'}</span></td>
                                                    <td><span class="status-badge status-${(user.Status || 'Active').toLowerCase()}">${user.Status || 'Active'}</span></td>
                                                    <td>${user.Last_Login ? new Date(user.Last_Login).toLocaleDateString() : 'Never'}</td>
                                                    <td>
                                                        <button class="btn-icon" onclick="removeUser('${user.User_ID}')" title="Remove access">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading facility users:', error);
                const container = document.getElementById('facilityUsersContainer');
                if (container) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #dc2626;">Error loading users</div>';
                }
            }
        }
        
        function openInviteUserModal() {
            const modal = document.getElementById('inviteUserModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('inviteEmail').value = '';
                document.getElementById('inviteRole').value = 'Manager';
            }
        }
        
        function closeInviteUserModal() {
            const modal = document.getElementById('inviteUserModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function sendInvite(event) {
            event.preventDefault();
            
            const email = document.getElementById('inviteEmail').value.trim();
            const role = document.getElementById('inviteRole').value;
            
            if (!email || !role) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'inviteUser');
                formData.append('data', JSON.stringify({
                    facilityId: currentFacilityId,
                    email: email,
                    role: role
                }));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Invite sent successfully!', 'success');
                    closeInviteUserModal();
                    loadFacilityUsers(); // Refresh the users list
                } else {
                    showToast('Error sending invite: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error sending invite:', error);
                showToast('Error sending invite: ' + error.toString(), 'error');
            }
        }
        
        async function removeUser(userId) {
            if (!confirm('Are you sure you want to remove this user\'s access to this facility?')) {
                return;
            }
            
            try {
                // TODO: Implement removeUser backend function
                showToast('Remove user feature coming soon', 'info');
                // For now, just refresh the list
                loadFacilityUsers();
            } catch (error) {
                console.error('Error removing user:', error);
                showToast('Error removing user', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }
        
        async function loadFacilityDetails() {
            try {
                const response = await fetch(`${API_URL}?action=getFacilityDetails&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    const facility = result.facility;
                    
                    // Populate form fields
                    document.getElementById('generalInformation').value = facility.General_Information || '';
                    document.getElementById('siteHours').value = facility.Site_Hours || '';
                    document.getElementById('latitude').value = facility.Latitude || '';
                    document.getElementById('longitude').value = facility.Longitude || '';
                    document.getElementById('submitBookingText').value = facility.Submit_Booking_Text || '';
                    document.getElementById('contractTemplate').value = facility.Contract_Template || getDefaultContractTemplate();
                    
                    // Handle 24/7 toggle
                    const is24Hours = facility.Is_24_Hours === 'TRUE' || facility.Site_Hours === '24/7';
                    document.getElementById('is24Hours').checked = is24Hours;
                    toggle24Hours();
                    
                    // Load unit type groups if available
                    if (facility.Unit_Type_Groups) {
                        try {
                            const groups = JSON.parse(facility.Unit_Type_Groups);
                            renderUnitTypeGroups(groups);
                        } catch (e) {
                            console.warn('Could not parse unit type groups');
                        }
                    }
                } else {
                    showToast('Failed to load facility details', 'error');
                }
            } catch (error) {
                console.error('Error loading facility details:', error);
                showToast('Error loading facility details', 'error');
            }
        }
        
        function getDefaultContractTemplate() {
            return `<h1>Storage Unit Rental Agreement</h1>
<p>This Rental Agreement ("Agreement") is entered into between <strong>{FACILITY_NAME}</strong> ("Landlord") and <strong>{CUSTOMER_NAME}</strong> ("Tenant") for the rental of storage unit <strong>{UNIT_NUMBER}</strong>.</p>

<h2>1. Rental Terms</h2>
<ul>
<li><strong>Unit Number:</strong> {UNIT_NUMBER}</li>
<li><strong>Monthly Rent:</strong> ${MONTHLY_RATE}</li>
<li><strong>Administration Fee:</strong> ${ADMIN_FEE} (one-time, covers hardware costs and subscriptions)</li>
<li><strong>Insurance Fee:</strong> ${INSURANCE_FEE} per month</li>
<li><strong>Tax Rate:</strong> {TAX_RATE}%</li>
<li><strong>Total Monthly Payment:</strong> ${TOTAL_MONTHLY}</li>
</ul>

<h2>2. Term</h2>
<p>This Agreement shall commence on the move-in date and continue on a month-to-month basis until terminated by either party with 30 days written notice.</p>

<h2>3. Payment Terms</h2>
<p>Rent is due on the first day of each month. Late fees may apply for payments received after the due date.</p>

<h2>4. Tenant Responsibilities</h2>
<ul>
<li>Maintain the unit in good condition</li>
<li>Not store prohibited items (hazardous materials, perishables, etc.)</li>
<li>Provide proper insurance coverage</li>
<li>Comply with all facility rules and regulations</li>
</ul>

<h2>5. Landlord Rights</h2>
<p>The Landlord reserves the right to access the unit for inspection, maintenance, or in case of emergency.</p>

<h2>6. Default</h2>
<p>If Tenant fails to pay rent or violates any terms of this Agreement, Landlord may terminate this Agreement and take possession of the unit.</p>

<p>By signing below, Tenant acknowledges that they have read, understood, and agree to all terms and conditions of this Agreement.</p>

<p><strong>Tenant Signature:</strong> _________________________</p>
<p><strong>Date:</strong> _________________________</p>`;
        }
        
        function toggle24Hours() {
            const is24Hours = document.getElementById('is24Hours').checked;
            const customHoursContainer = document.getElementById('customHoursContainer');
            const siteHoursTextarea = document.getElementById('siteHours');
            
            if (is24Hours) {
                customHoursContainer.style.display = 'none';
                siteHoursTextarea.value = '24/7';
            } else {
                customHoursContainer.style.display = 'block';
                if (siteHoursTextarea.value === '24/7') {
                    siteHoursTextarea.value = '';
                }
            }
        }
        
        function previewContract() {
            const template = document.getElementById('contractTemplate').value;
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Contract Preview</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #111827; }
                        h2 { color: #374151; margin-top: 24px; }
                    </style>
                </head>
                <body>
                    ${template.replace(/\{FACILITY_NAME\}/g, 'Sample Facility')
                              .replace(/\{CUSTOMER_NAME\}/g, 'John Doe')
                              .replace(/\{UNIT_NUMBER\}/g, '101')
                              .replace(/\{MONTHLY_RATE\}/g, '$100.00')
                              .replace(/\{ADMIN_FEE\}/g, '$15.00')
                              .replace(/\{INSURANCE_FEE\}/g, '$15.00')
                              .replace(/\{TAX_RATE\}/g, '6.5')
                              .replace(/\{TOTAL_MONTHLY\}/g, '$130.00')}
                </body>
                </html>
            `);
        }
        
        function toggleEditMode(section) {
            const textareas = {
                'general': document.getElementById('generalInformation'),
                'hours': document.getElementById('siteHours'),
                'booking': document.getElementById('submitBookingText'),
                'contract': document.getElementById('contractTemplate')
            };
            
            const inputs = {
                'location': [document.getElementById('latitude'), document.getElementById('longitude')]
            };
            
            const actions = {
                'general': document.getElementById('generalActions'),
                'hours': document.getElementById('hoursActions'),
                'location': document.getElementById('locationActions'),
                'booking': document.getElementById('bookingActions'),
                'contract': document.getElementById('contractActions')
            };
            
            if (textareas[section]) {
                textareas[section].disabled = false;
                textareas[section].focus();
            }
            
            if (inputs[section]) {
                inputs[section].forEach(input => {
                    if (input) input.disabled = false;
                });
            }
            
            if (actions[section]) {
                actions[section].style.display = 'flex';
            }
        }
        
        function cancelEditMode(section) {
            const textareas = {
                'general': document.getElementById('generalInformation'),
                'hours': document.getElementById('siteHours'),
                'booking': document.getElementById('submitBookingText'),
                'contract': document.getElementById('contractTemplate')
            };
            
            const inputs = {
                'location': [document.getElementById('latitude'), document.getElementById('longitude')]
            };
            
            const actions = {
                'general': document.getElementById('generalActions'),
                'hours': document.getElementById('hoursActions'),
                'location': document.getElementById('locationActions'),
                'booking': document.getElementById('bookingActions'),
                'contract': document.getElementById('contractActions')
            };
            
            if (textareas[section]) {
                textareas[section].disabled = true;
            }
            
            if (inputs[section]) {
                inputs[section].forEach(input => {
                    if (input) input.disabled = true;
                });
            }
            
            if (actions[section]) {
                actions[section].style.display = 'none';
            }
            
            // Reload to restore original values
            loadFacilityDetails();
        }
        
        async function saveDetailsSection(section) {
            try {
                const data = {
                    facilityId: currentFacilityId
                };
                
                if (section === 'general') {
                    data.General_Information = document.getElementById('generalInformation').value;
                } else if (section === 'hours') {
                    const is24Hours = document.getElementById('is24Hours').checked;
                    data.Is_24_Hours = is24Hours ? 'TRUE' : 'FALSE';
                    data.Site_Hours = is24Hours ? '24/7' : document.getElementById('siteHours').value;
                } else if (section === 'location') {
                    data.Latitude = document.getElementById('latitude').value;
                    data.Longitude = document.getElementById('longitude').value;
                } else if (section === 'booking') {
                    data.Submit_Booking_Text = document.getElementById('submitBookingText').value;
                } else if (section === 'contract') {
                    data.Contract_Template = document.getElementById('contractTemplate').value;
                }
                
                const response = await fetch(`${API_URL}?action=updateFacilityDetails`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Details saved successfully', 'success');
                    cancelEditMode(section);
                } else {
                    showToast(result.error || 'Failed to save details', 'error');
                }
            } catch (error) {
                console.error('Error saving details:', error);
                showToast('Error saving details', 'error');
            }
        }
        
        function showInfo(section) {
            // Info boxes are already visible, this could toggle them or show a modal
            console.log('Show info for:', section);
        }
        
        function addUnitTypeGroup() {
            showToast('Unit type groups feature coming soon', 'info');
        }
        
        function renderUnitTypeGroups(groups) {
            const container = document.getElementById('unitTypeGroupsList');
            if (!groups || groups.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #6b7280;">No unit type groups configured</div>';
                return;
            }
            
            // Render groups (placeholder for now)
            container.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #6b7280;">Unit type groups feature coming soon</div>';
        }
        
        async function loadJobs() {
            try {
                const tbody = document.getElementById('jobsTableBody');
                if (!tbody) {
                    console.warn('jobsTableBody element not found');
                    return;
                }
                
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="loading">Loading jobs...</div></td></tr>';
                
                const response = await fetch(`${API_URL}?action=getJobs&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success && result.jobs) {
                    if (result.jobs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">There are no jobs</td></tr>';
                    } else {
                        renderJobsTable(result.jobs);
                    }
                } else {
                    throw new Error(result.error || 'Failed to load jobs');
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                const tbody = document.getElementById('jobsTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error loading jobs: ' + error.message + '</td></tr>';
                }
            }
        }
        
        function removeFilter(filterType) {
            const chip = document.getElementById(filterType + 'FilterChip');
            if (chip) {
                chip.remove();
            }
            loadJobs(); // Reload with updated filters
        }
        
        function toggleFilterDropdown(filterType) {
            // TODO: Implement dropdown menu for dates and labels
            console.log('Toggle filter dropdown:', filterType);
        }
        
        function renderJobsTable(jobs) {
            const tbody = document.getElementById('jobsTableBody');
            if (!tbody) return;
            
            if (!jobs || jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">There are no jobs</td></tr>';
                return;
            }
            
            tbody.innerHTML = jobs.map(job => `
                <tr>
                    <td>${formatDate(job.Date)}</td>
                    <td><span class="job-type-badge job-type-${job.Type.toLowerCase()}">${job.Type}</span></td>
                    <td>${job.Customer_Name || 'N/A'}</td>
                    <td>${job.Unit_Number || 'N/A'}</td>
                    <td><span class="status-badge status-${job.Status.toLowerCase()}">${job.Status}</span></td>
                    <td>${job.Assigned_To || 'Unassigned'}</td>
                    <td>
                        <button class="btn-icon" onclick="viewJob('${job.Job_ID}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editJob('${job.Job_ID}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function viewJob(jobId) {
            showToast('View job feature coming soon', 'info');
        }
        
        function editJob(jobId) {
            showToast('Edit job feature coming soon', 'info');
        }
        
        let allInvoices = [];
        let filteredInvoices = [];
        let invoiceFilterStatus = 'all';
        
        async function loadInvoices() {
            try {
                const container = document.getElementById('invoicesListContainer');
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;"><div class="loading">Loading invoices...</div></div>';
                
                const response = await fetch(`${API_URL}?action=getInvoices&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    allInvoices = result.invoices || [];
                    filteredInvoices = [...allInvoices];
                    renderInvoices();
                    
                    // Update overdue alert
                    const overdueCount = allInvoices.filter(inv => {
                        const dueDate = new Date(inv.Due_Date);
                        const today = new Date();
                        return inv.Status === 'Pending' && dueDate < today;
                    }).length;
                    
                    if (overdueCount > 0) {
                        document.getElementById('invoicesOverdueAlert').style.display = 'block';
                        document.getElementById('overdueUnitsCount').textContent = `This site has ${overdueCount} overdue unit${overdueCount > 1 ? 's' : ''}.`;
                    } else {
                        document.getElementById('invoicesOverdueAlert').style.display = 'none';
                    }
                } else {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #dc2626;">Error loading invoices: ' + (result.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                const container = document.getElementById('invoicesListContainer');
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #dc2626;">Error loading invoices. Please try again.</div>';
            }
        }
        
        function renderInvoices() {
            const container = document.getElementById('invoicesListContainer');
            
            if (filteredInvoices.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">No invoices found</div>';
                return;
            }
            
            container.innerHTML = filteredInvoices.map(invoice => {
                const invoiceId = invoice.Invoice_ID || invoice.invoiceId || '';
                const customerName = invoice.Customer_Name || invoice.customerName || 'Unknown Customer';
                const unitNumber = invoice.Unit_Number || invoice.unitNumber || '';
                const amount = parseFloat(invoice.Amount || 0);
                const status = invoice.Status || 'Draft';
                const dueDate = invoice.Due_Date ? new Date(invoice.Due_Date) : null;
                const createdDate = invoice.Created_Date ? new Date(invoice.Created_Date) : new Date();
                
                // Calculate date range (invoice period - same month as due date)
                const startDate = dueDate ? new Date(dueDate.getFullYear(), dueDate.getMonth(), 1) : createdDate;
                const endDate = dueDate ? new Date(dueDate.getFullYear(), dueDate.getMonth() + 1, 0) : createdDate;
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                const statusColors = {
                    'Draft': { bg: '#fef3c7', text: '#92400e' },
                    'Sent': { bg: '#dbeafe', text: '#1e40af' },
                    'Paid': { bg: '#d1fae5', text: '#065f46' },
                    'Failed': { bg: '#fee2e2', text: '#991b1b' },
                    'Pending': { bg: '#f3f4f6', text: '#374151' },
                    'Overdue': { bg: '#fee2e2', text: '#991b1b' }
                };
                
                const statusColor = statusColors[status] || statusColors['Draft'];
                
                return `
                    <div class="invoice-list-item" onclick="viewInvoiceDetail('${invoiceId}')" style="padding: 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #111827; margin-bottom: 4px;">${customerName}</div>
                            <div style="font-size: 13px; color: #6b7280; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-invoice" style="font-size: 11px;"></i>
                                <span>${invoiceId.substring(0, 3)} ${invoiceId.substring(3, 13)}</span>
                                ${unitNumber ? `<span style="margin-left: 8px;"> Unit ${unitNumber}</span>` : ''}
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 0; text-align: left;">
                            <div style="font-size: 13px; color: #6b7280;">
                                ${startDateStr}  ${endDateStr}
                            </div>
                        </div>
                        <div style="font-weight: 600; color: #111827; font-size: 15px; min-width: 100px; text-align: right;">
                            $${amount.toFixed(2)}
                        </div>
                        <div style="min-width: 80px; text-align: right;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${statusColor.bg}; color: ${statusColor.text};">
                                ${status}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        const statusColors = {
            'Draft': { bg: '#fef3c7', text: '#92400e' },
            'Sent': { bg: '#dbeafe', text: '#1e40af' },
            'Paid': { bg: '#d1fae5', text: '#065f46' },
            'Failed': { bg: '#fee2e2', text: '#991b1b' },
            'Pending': { bg: '#f3f4f6', text: '#374151' },
            'Overdue': { bg: '#fee2e2', text: '#991b1b' }
        };
        
        function filterInvoices(status) {
            invoiceFilterStatus = status;
            const buttons = document.querySelectorAll('.invoice-filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.status === status) {
                    btn.style.background = status === 'all' ? '#e5e7eb' : (statusColors[status]?.bg || '#f3f4f6');
                    btn.style.borderColor = status === 'all' ? '#9ca3af' : (statusColors[status]?.text || '#d1d5db');
                } else {
                    btn.style.background = '#fff';
                    btn.style.borderColor = '#d1d5db';
                }
            });
            
            filteredInvoices = status === 'all' 
                ? [...allInvoices]
                : allInvoices.filter(inv => inv.Status === status);
            
            renderInvoices();
        }
        
        function filterInvoicesByDate(dateRange) {
            // TODO: Implement date filtering
            renderInvoices();
        }
        
        function filterInvoicesByCustomer(customerId) {
            // TODO: Implement customer filtering
            renderInvoices();
        }
        
        function filterInvoicesByLabel(label) {
            // TODO: Implement label filtering
            renderInvoices();
        }
        
        function filterInvoicesBySearch(searchTerm) {
            if (!searchTerm) {
                filteredInvoices = invoiceFilterStatus === 'all' ? [...allInvoices] : allInvoices.filter(inv => inv.Status === invoiceFilterStatus);
            } else {
                filteredInvoices = allInvoices.filter(inv => {
                    const invoiceId = (inv.Invoice_ID || inv.invoiceId || '').toLowerCase();
                    const customerName = (inv.Customer_Name || inv.customerName || '').toLowerCase();
                    return invoiceId.includes(searchTerm.toLowerCase()) || customerName.includes(searchTerm.toLowerCase());
                });
            }
            renderInvoices();
        }
        
        function viewInvoiceDetail(invoiceId) {
            const invoice = allInvoices.find(inv => (inv.Invoice_ID || inv.invoiceId) === invoiceId);
            if (!invoice) {
                showToast('Invoice not found', 'error');
                return;
            }
            
            // Show modal with invoice details
            document.getElementById('invoiceDetailModal').style.display = 'flex';
            document.getElementById('invoiceDetailTitle').textContent = `Invoice ${invoiceId}`;
            document.getElementById('invoiceDetailContent').innerHTML = '<div class="loading">Loading invoice details...</div>';
            
            // Load full invoice details via API
            loadInvoiceDetail(invoiceId);
        }
        
        async function loadInvoiceDetail(invoiceId) {
            try {
                const response = await fetch(`${API_URL}?action=getInvoiceDetail&invoiceId=${invoiceId}&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    renderInvoiceDetail(result.invoice);
                } else {
                    document.getElementById('invoiceDetailContent').innerHTML = '<div style="color: #dc2626;">Error loading invoice details</div>';
                }
            } catch (error) {
                console.error('Error loading invoice detail:', error);
                document.getElementById('invoiceDetailContent').innerHTML = '<div style="color: #dc2626;">Error loading invoice details</div>';
            }
        }
        
        let currentInvoiceDetail = null;
        
        function renderInvoiceDetail(invoice) {
            currentInvoiceDetail = invoice;
            const invoiceId = invoice.Invoice_ID || invoice.invoiceId || '';
            const customerName = invoice.Customer_Name || invoice.customerName || 'Unknown Customer';
            const unitNumber = invoice.Unit_Number || invoice.unitNumber || '';
            const amount = parseFloat(invoice.Amount || 0);
            const dueDate = invoice.Due_Date ? new Date(invoice.Due_Date) : null;
            const status = invoice.Status || 'Draft';
            const sentDate = invoice.Sent_Date ? new Date(invoice.Sent_Date) : null;
            const paymentDate = invoice.Payment_Date ? new Date(invoice.Payment_Date) : null;
            const autopayDiscount = invoice.Autopay_Discount_Applied === 'TRUE' || invoice.Autopay_Discount_Applied === true ? 5 : 0;
            
            const paymentHistory = invoice.Payment_History || invoice.paymentHistory || [];
            
            const statusColors = {
                'Draft': { bg: '#fef3c7', text: '#92400e' },
                'Sent': { bg: '#dbeafe', text: '#1e40af' },
                'Paid': { bg: '#d1fae5', text: '#065f46' },
                'Failed': { bg: '#fee2e2', text: '#991b1b' },
                'Pending': { bg: '#f3f4f6', text: '#374151' },
                'Overdue': { bg: '#fee2e2', text: '#991b1b' }
            };
            
            const statusColor = statusColors[status] || statusColors['Draft'];
            
            const html = `
                <div style="padding: 24px 0;">
                    <!-- Invoice Summary -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin-bottom: 24px; border: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Customer</div>
                                <div style="font-size: 16px; font-weight: 600; color: #111827;">${customerName}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Unit</div>
                                <div style="font-size: 16px; font-weight: 600; color: #111827;">${unitNumber || 'N/A'}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Amount</div>
                                <div style="font-size: 24px; font-weight: 700; color: #2563eb;">$${amount.toFixed(2)}</div>
                                ${autopayDiscount > 0 ? `<div style="font-size: 13px; color: #059669; margin-top: 4px;"><i class="fas fa-check-circle"></i> $${autopayDiscount.toFixed(2)} autopay discount applied</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Due Date</div>
                                <div style="font-size: 16px; font-weight: 600; color: #111827;">${dueDate ? dueDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Status</div>
                                <div>
                                    <span style="padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: ${statusColor.bg}; color: ${statusColor.text};">
                                        ${status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoice Dates -->
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 16px 0;">Invoice Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">Invoice ID</div>
                                <div style="font-size: 14px; font-weight: 500; color: #111827; font-family: monospace;">${invoiceId}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">Sent Date</div>
                                <div style="font-size: 14px; font-weight: 500; color: #111827;">${sentDate ? sentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not sent'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">Payment Date</div>
                                <div style="font-size: 14px; font-weight: 500; color: #111827;">${paymentDate ? paymentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not paid'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">Autopay Discount</div>
                                <div style="font-size: 14px; font-weight: 500; color: #111827;">${autopayDiscount > 0 ? `$${autopayDiscount.toFixed(2)}` : 'None'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment History -->
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 16px 0;">Payment History</h3>
                        ${paymentHistory && paymentHistory.length > 0 ? `
                            <div class="table-container" style="margin: 0; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Transaction ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${paymentHistory.map(payment => `
                                            <tr>
                                                <td>${payment.Date ? new Date(payment.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}</td>
                                                <td>$${parseFloat(payment.Amount || 0).toFixed(2)}</td>
                                                <td>${payment.Method || 'N/A'}</td>
                                                <td style="font-family: monospace; font-size: 12px;">${payment.Transaction_ID || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding: 40px; text-align: center; color: #6b7280;">
                                <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                <p>No payments recorded yet</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="sendInvoiceEmailFromModal(event)">
                            <i class="fas fa-envelope"></i> Send Email
                        </button>
                        <button class="btn btn-secondary" onclick="viewInvoicePdf()">
                            <i class="fas fa-file-pdf"></i> View PDF
                        </button>
                        ${status !== 'Paid' ? `
                            <button class="btn btn-primary" onclick="openRecordPaymentModal('${invoiceId}')">
                                <i class="fas fa-dollar-sign"></i> Record Payment
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('invoiceDetailContent').innerHTML = html;
        }
        
        function closeInvoiceDetail() {
            document.getElementById('invoiceDetailModal').style.display = 'none';
            currentInvoiceDetail = null;
        }
        
        async function sendInvoiceEmailFromModal(event) {
            if (!currentInvoiceDetail) return;
            
            const invoiceId = currentInvoiceDetail.Invoice_ID || currentInvoiceDetail.invoiceId;
            if (!invoiceId) return;
            
            const btn = event ? event.target.closest('button') : document.querySelector('[onclick="sendInvoiceEmailFromModal()"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=sendInvoiceEmail&invoiceId=${invoiceId}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast('Invoice email sent successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to send email');
                }
            } catch (error) {
                console.error('Error sending invoice email:', error);
                showToast('Error sending email: ' + error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }
        
        function viewInvoicePdf() {
            if (!currentInvoiceDetail) return;
            
            // TODO: Get PDF URL from backend or generate it
            const invoiceId = currentInvoiceDetail.Invoice_ID || currentInvoiceDetail.invoiceId;
            showToast('PDF view feature coming soon', 'info');
        }
        
        function openRecordPaymentModal(invoiceId) {
            document.getElementById('recordPaymentInvoiceId').value = invoiceId || '';
            document.getElementById('recordPaymentForm').reset();
            document.getElementById('recordPaymentInvoiceId').value = invoiceId || '';
            
            // Pre-fill amount if available
            if (currentInvoiceDetail) {
                const amount = parseFloat(currentInvoiceDetail.Amount || 0);
                document.getElementById('recordPaymentAmount').value = amount.toFixed(2);
            }
            
            document.getElementById('recordPaymentModal').style.display = 'flex';
        }
        
        function closeRecordPaymentModal() {
            document.getElementById('recordPaymentModal').style.display = 'none';
        }
        
        async function saveRecordedPayment(event) {
            event.preventDefault();
            
            const invoiceId = document.getElementById('recordPaymentInvoiceId').value;
            const amount = parseFloat(document.getElementById('recordPaymentAmount').value);
            const method = document.getElementById('recordPaymentMethod').value;
            const transactionId = document.getElementById('recordPaymentTransactionId').value;
            
            if (!invoiceId || !amount || !method) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recording...';
            
            try {
                const response = await fetch(`${API_URL}?action=recordPayment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoiceId: invoiceId,
                        amount: amount,
                        method: method,
                        transactionId: transactionId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Payment recorded successfully', 'success');
                    closeRecordPaymentModal();
                    
                    // Reload invoice detail
                    if (currentInvoiceDetail) {
                        await loadInvoiceDetail(invoiceId);
                    }
                    
                    // Reload invoices list
                    await loadInvoices();
                } else {
                    throw new Error(result.error || 'Failed to record payment');
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                showToast('Error recording payment: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        async function loadUnitTypes() {
            const tbody = document.getElementById('unitTypesTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No unit types found</td></tr>';
        }
        
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No products found</td></tr>';
        }
        
        async function loadAddons() {
            // Already handled in HTML
        }
        
        async function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No history found</td></tr>';
        }
        
        function openUnitTypeModal() {
            showToast('Unit types feature coming soon', 'info');
        }
        
        function openProductModal() {
            showToast('Products feature coming soon', 'info');
        }

        async function loadOverview() {
            try {
                const response = await fetch(`${API_URL}?action=getManagerDashboard&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // Update metrics
                    document.getElementById('revenueValue').textContent = `$${data.monthlyRevenue.toLocaleString()}`;
                    document.getElementById('occupancyValue').textContent = `${data.occupancyRate}%`;
                    document.getElementById('occupancyInfo').textContent = `${data.occupiedUnits} / ${data.totalUnits} units`;
                    document.getElementById('customersValue').textContent = data.activeCustomers;
                    document.getElementById('availableValue').textContent = data.availableUnits;
                    
                    // Update badges
                    document.getElementById('unitsBadge').textContent = data.totalUnits;
                    document.getElementById('customersBadge').textContent = data.activeCustomers;
                    
                    // Update facility name
                    document.getElementById('facilityName').textContent = data.facilityName || 'Facility';
                    
                    // Set Meridian logo as facility image
                    // Render chart
                    renderOccupancyChart(data);
                    
                    // Load activity
                    loadActivity();
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                showToast('Error loading dashboard', 'error');
            }
        }

        function renderOccupancyChart(data) {
            const ctx = document.getElementById('occupancyChart');
            if (!ctx) return;
            
            // Store data for chart type switching
            chartData = data;
            
            if (occupancyChart) {
                occupancyChart.destroy();
            }
            
            const labels = ['Occupied', 'Available', 'Reserved'];
            const values = [data.occupiedUnits || 0, data.availableUnits || 0, data.reservedUnits || 0];
            const colors = ['#3b82f6', '#10b981', '#f59e0b'];
            
            const chartConfig = {
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Units',
                        data: values,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed.y || context.parsed;
                                    const total = values.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };
            
            if (currentChartType === 'bar') {
                chartConfig.type = 'bar';
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                };
            } else {
                chartConfig.type = 'pie';
            }
            
            occupancyChart = new Chart(ctx, chartConfig);
        }
        
        function switchChartType(type) {
            currentChartType = type;
            
            // Update button states
            document.getElementById('pieBtn').classList.toggle('active', type === 'pie');
            document.getElementById('barBtn').classList.toggle('active', type === 'bar');
            
            // Re-render chart with new type
            if (chartData) {
                renderOccupancyChart(chartData);
            }
        }

        async function loadActivity() {
            try {
                const tbody = document.getElementById('activityTableBody');
                if (!tbody) {
                    console.warn('activityTableBody not found');
                    return;
                }
                
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><div class="loading">Loading activity...</div></td></tr>';
                
                const response = await fetch(`${API_URL}?action=getActivity&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success && result.activity) {
                    if (result.activity.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No recent activity</td></tr>';
                    } else {
                        tbody.innerHTML = result.activity.map(activity => {
                            const date = new Date(activity.date);
                            const icon = activity.type === 'payment' ? 'fa-dollar-sign' : 'fa-sign-in-alt';
                            const color = activity.type === 'payment' ? '#10b981' : '#3b82f6';
                            
                            return `
                                <tr>
                                    <td>
                                        <i class="fas ${icon}" style="color: ${color}; margin-right: 8px;"></i>
                                        ${activity.description}
                                    </td>
                                    <td>${activity.type === 'payment' ? '$' + parseFloat(activity.amount || 0).toFixed(2) : '-'}</td>
                                    <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                                    <td>${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                } else {
                    throw new Error(result.error || 'Failed to load activity');
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                const tbody = document.getElementById('activityTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Error loading activity</td></tr>';
                }
            }
        }

        async function loadUnits() {
            const status = document.getElementById('unitStatusFilter').value;
            const search = document.getElementById('unitSearch').value.toLowerCase();
            
            try {
                const response = await fetch(`${API_URL}?action=getUnits&facilityId=${currentFacilityId}&status=${status}`);
                const result = await response.json();
                
                if (result.success) {
                    unitsData = result.units || [];
                    let filtered = unitsData;
                    
                    if (search) {
                        filtered = unitsData.filter(u => 
                            (u.Unit_Number || '').toLowerCase().includes(search)
                        );
                    }
                    
                    renderUnitsTable(filtered);
                }
            } catch (error) {
                console.error('Error loading units:', error);
                showToast('Error loading units', 'error');
            }
        }

        function renderUnitsTable(units) {
            const tbody = document.getElementById('unitsTableBody');
            
            if (units.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No units found</td></tr>';
                return;
            }
            
            tbody.innerHTML = units.map(unit => `
                <tr style="cursor: pointer;" onclick="viewUnitDetail('${unit.Unit_ID}')">
                    <td><strong style="color: #2563eb;">${unit.Unit_Number || ''}</strong></td>
                    <td>${unit.Size || ''}</td>
                    <td><span class="status-badge status-${(unit.Status || 'Available').toLowerCase()}">${unit.Status || 'Available'}</span></td>
                    <td>${unit.Customer_Name || '-'}</td>
                    <td>$${(unit.Monthly_Rate || 0).toLocaleString()}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-secondary" onclick="editUnit('${unit.Unit_ID}')">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteUnit('${unit.Unit_ID}')" style="color: var(--danger);">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            
            try {
                const response = await fetch(`${API_URL}?action=getCustomers&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    customersData = result.customers || [];
                    let filtered = customersData;
                    
                    if (search) {
                        filtered = customersData.filter(c => 
                            ((c.First_Name || '') + ' ' + (c.Last_Name || '')).toLowerCase().includes(search) ||
                            (c.Email || '').toLowerCase().includes(search) ||
                            (c.Gate_Code || '').includes(search)
                        );
                    }
                    
                    renderCustomersTable(filtered);
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showToast('Error loading customers', 'error');
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No customers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = customers.map(customer => {
                const gateCode = customer.Gate_Code || 'N/A';
                const balance = parseFloat(customer.Balance) || 0;
                const status = customer.Status || 'Active';
                const isLocked = status === 'Locked' || status === 'Suspended' || status === 'Past Due';
                
                return `
                <tr class="${isLocked ? 'locked-row' : ''}">
                    <td><strong>${customer.First_Name || ''} ${customer.Last_Name || ''}</strong></td>
                    <td>${customer.Email || ''}</td>
                    <td>${customer.Phone || '-'}</td>
                    <td>${customer.Unit_Number || '-'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 14px; font-weight: 600; color: #1e40af;">${gateCode}</code>
                            <button class="btn btn-sm btn-secondary" onclick="editGateCode('${customer.Customer_ID}', '${gateCode}')" title="Edit gate code" style="padding: 4px 8px; font-size: 12px;"></button>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-${status.toLowerCase().replace(' ', '-')}">${status}</span>
                        ${isLocked ? '<span style="color: #ef4444; font-size: 12px; margin-left: 4px;"></span>' : ''}
                    </td>
                    <td>
                        <span style="color: ${balance > 0 ? '#ef4444' : '#10b981'}; font-weight: 600;">
                            $${balance.toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCustomer('${customer.Customer_ID}')">Edit</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        async function editGateCode(customerId, currentCode) {
            const newCode = prompt(`Edit Gate Code\n\nCurrent Code: ${currentCode}\n\nEnter new 4-digit gate code:`, currentCode);
            
            if (!newCode) return;
            
            // Validate format
            if (!/^\d{4}$/.test(newCode)) {
                showToast('Gate code must be exactly 4 digits', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=updateGateCode&customerId=${customerId}&gateCode=${newCode}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast(' Gate code updated successfully', 'success');
                    loadCustomers();
                } else {
                    throw new Error(result.error || 'Failed to update gate code');
                }
            } catch (error) {
                console.error('Error updating gate code:', error);
                showToast(error.message || 'Failed to update gate code', 'error');
            }
        }
        
        async function syncGateAccess() {
            if (!confirm('This will automatically lockout customers who are past due on payments. Continue?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = ' Syncing...';
            
            try {
                const response = await fetch(`${API_URL}?action=syncGateCodes&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast(` ${result.message || 'Gate access synced successfully'}`, 'success');
                    loadCustomers();
                } else {
                    throw new Error(result.error || 'Failed to sync gate access');
                }
            } catch (error) {
                console.error('Error syncing gate access:', error);
                showToast(error.message || 'Failed to sync gate access', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function openUnitModal(unitId = null) {
            const modal = document.getElementById('unitModal');
            const form = document.getElementById('unitForm');
            const title = document.getElementById('unitModalTitle');
            const sizeSelect = document.getElementById('unitSize');
            const customSizeInput = document.getElementById('unitSizeCustom');
            
            if (unitId) {
                title.textContent = 'Edit Unit';
                const unit = unitsData.find(u => u.Unit_ID === unitId);
                if (unit) {
                    document.getElementById('unitId').value = unitId;
                    document.getElementById('unitNumber').value = unit.Unit_Number || '';
                    const size = unit.Size || '';
                    // Check if size is in dropdown, otherwise use custom
                    if (sizeSelect.querySelector(`option[value="${size}"]`)) {
                        sizeSelect.value = size;
                        customSizeInput.style.display = 'none';
                    } else {
                        sizeSelect.value = 'Custom';
                        customSizeInput.value = size;
                        customSizeInput.style.display = 'block';
                    }
                    document.getElementById('unitRate').value = unit.Monthly_Rate || '';
                    document.getElementById('unitStatus').value = unit.Status || 'Available';
                    document.getElementById('unitCustomer').value = unit.Customer_ID || '';
                }
            } else {
                title.textContent = 'Add Unit';
                form.reset();
                document.getElementById('unitId').value = '';
                customSizeInput.style.display = 'none';
            }
            
            // Handle size select change
            sizeSelect.onchange = function() {
                if (this.value === 'Custom') {
                    customSizeInput.style.display = 'block';
                    customSizeInput.required = true;
                } else {
                    customSizeInput.style.display = 'none';
                    customSizeInput.required = false;
                    customSizeInput.value = '';
                }
            };
            
            // Load customers for dropdown
            loadCustomersForUnit();
            
            modal.classList.add('show');
        }

        function closeUnitModal() {
            document.getElementById('unitModal').classList.remove('show');
        }

        function openBulkAddModal() {
            const modal = document.getElementById('bulkAddModal');
            const form = document.getElementById('bulkAddForm');
            form.reset();
            document.getElementById('bulkCount').value = 10;
            document.getElementById('bulkStatus').value = 'Available';
            document.getElementById('bulkSizeCustom').style.display = 'none';
            updateBulkPreview();
            modal.classList.add('show');
        }

        function closeBulkAddModal() {
            document.getElementById('bulkAddModal').classList.remove('show');
        }

        function updateBulkPreview() {
            const start = document.getElementById('bulkStartNumber').value || '101';
            const count = parseInt(document.getElementById('bulkCount').value) || 10;
            const size = document.getElementById('bulkSize').value || '-';
            const rate = parseFloat(document.getElementById('bulkRate').value) || 0;
            const customSize = document.getElementById('bulkSizeCustom').value;
            
            // Calculate end number
            const startNum = parseInt(start) || 1;
            const endNum = startNum + count - 1;
            
            // Update preview
            document.getElementById('bulkPreview').textContent = count;
            document.getElementById('bulkPreviewStart').textContent = start;
            document.getElementById('bulkPreviewEnd').textContent = endNum;
            document.getElementById('bulkPreviewSize').textContent = customSize || size || '-';
            document.getElementById('bulkPreviewRate').textContent = rate > 0 ? `$${rate.toFixed(2)}` : '-';
            document.getElementById('bulkSubmitCount').textContent = count;
        }

        function updateCustomSize() {
            const sizeSelect = document.getElementById('bulkSize');
            const customInput = document.getElementById('bulkSizeCustom');
            if (sizeSelect.value === 'Custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
            updateBulkPreview();
        }

        // Add event listeners for preview updates
        document.addEventListener('DOMContentLoaded', () => {
            const bulkStart = document.getElementById('bulkStartNumber');
            const bulkCount = document.getElementById('bulkCount');
            const bulkSize = document.getElementById('bulkSize');
            const bulkRate = document.getElementById('bulkRate');
            
            if (bulkStart) bulkStart.addEventListener('input', updateBulkPreview);
            if (bulkCount) bulkCount.addEventListener('input', updateBulkPreview);
            if (bulkSize) bulkSize.addEventListener('change', updateCustomSize);
            if (bulkRate) bulkRate.addEventListener('input', updateBulkPreview);
            
            // Initialize preview
            setTimeout(updateBulkPreview, 100);
        });

        async function saveBulkUnits(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const startNumber = formData.get('startNumber');
            const count = parseInt(formData.get('count'));
            let size = formData.get('size');
            const customSize = formData.get('sizeCustom');
            const rate = parseFloat(formData.get('rate'));
            const status = formData.get('status');
            
            // Use custom size if provided
            if (size === 'Custom' && customSize) {
                size = customSize;
            }
            
            if (!startNumber || !count || !size || !rate) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            if (count > 200) {
                showToast('Maximum 200 units can be created at once', 'error');
                return;
            }
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><span style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite;"></span>Creating Units...</span>';
            
            try {
                const data = {
                    facilityId: currentFacilityId,
                    startNumber: startNumber,
                    count: count,
                    size: size,
                    monthlyRate: rate,
                    status: status
                };
                
                // Use GET request with URL parameters
                const params = new URLSearchParams({
                    action: 'bulkCreateUnits',
                    data: JSON.stringify(data)
                });
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast(` Successfully created ${count} units!`, 'success');
                    closeBulkAddModal();
                    setTimeout(() => {
                        loadUnits();
                        loadOverview();
                    }, 500);
                } else {
                    throw new Error(result.error || 'Failed to create units');
                }
            } catch (error) {
                console.error('Error creating bulk units:', error);
                showToast(error.message || 'Failed to create units', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function loadCustomersForUnit() {
            const select = document.getElementById('unitCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            
            customersData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.Customer_ID;
                option.textContent = `${customer.First_Name} ${customer.Last_Name}`;
                select.appendChild(option);
            });
        }

        async function saveUnit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const unitId = formData.get('unitId');
            let size = formData.get('Size');
            const customSize = formData.get('SizeCustom');
            
            // Use custom size if provided
            if (size === 'Custom' && customSize) {
                size = customSize;
            }
            
            const data = {
                Facility_ID: currentFacilityId,
                Unit_Number: formData.get('Unit_Number'),
                Size: size,
                Monthly_Rate: parseFloat(formData.get('Monthly_Rate')),
                Status: formData.get('Status'),
                Customer_ID: formData.get('Customer_ID') || null
            };
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = unitId ? 'Updating...' : 'Creating...';
            
            try {
                const url = unitId 
                    ? `${API_URL}?action=updateUnit&unitId=${unitId}&data=${encodeURIComponent(JSON.stringify(data))}`
                    : `${API_URL}?action=createUnit&data=${encodeURIComponent(JSON.stringify(data))}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    showToast(unitId ? ' Unit updated successfully' : ' Unit created successfully', 'success');
                    closeUnitModal();
                    loadUnits();
                    loadOverview();
                } else {
                    throw new Error(result.error || 'Failed to save unit');
                }
            } catch (error) {
                console.error('Error saving unit:', error);
                showToast('Error saving unit: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        let currentUnitDetail = null;
        let currentUnitDetailTab = 'overview';
        
        function viewUnitDetail(unitId) {
            document.getElementById('unitDetailModal').style.display = 'flex';
            const sidebar = document.getElementById('unitDetailSidebar');
            const content = document.getElementById('unitDetailContent');
            sidebar.innerHTML = '<div class="loading">Loading unit...</div>';
            content.innerHTML = '<div class="loading">Loading unit details...</div>';
            
            loadUnitDetail(unitId);
        }
        
        function closeUnitDetail() {
            document.getElementById('unitDetailModal').style.display = 'none';
            currentUnitDetail = null;
            currentUnitDetailTab = 'overview';
        }
        
        function switchUnitDetailTab(tab) {
            currentUnitDetailTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.unit-detail-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });
            
            // Render tab content
            if (currentUnitDetail) {
                renderUnitDetailTab(tab);
            }
        }
        
        async function loadUnitDetail(unitId) {
            try {
                if (!currentFacilityId) {
                    console.error('No facility ID set');
                    return;
                }
                
                const url = `${API_URL}?action=getUnitDetails&unitId=${encodeURIComponent(unitId)}&facilityId=${encodeURIComponent(currentFacilityId)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    currentUnitDetail = result.unit;
                    const unit = result.unit;
                    
                    // Update breadcrumb
                    const facilityNameEl = document.getElementById('facilityNameBreadcrumb');
                    const unitNumberEl = document.getElementById('unitNumberBreadcrumb');
                    if (facilityNameEl) facilityNameEl.textContent = facilityNameEl.textContent || 'Facility';
                    if (unitNumberEl) unitNumberEl.textContent = unit.Unit_Number || '';
                    
                    // Render sidebar
                    renderUnitDetailSidebar(unit);
                    
                    // Render tab content
                    renderUnitDetailTab(currentUnitDetailTab);
                } else {
                    const errorMsg = result.error || 'Unknown error';
                    console.error('Error loading unit detail:', errorMsg);
                    document.getElementById('unitDetailContent').innerHTML = '<div style="color: #dc2626; padding: 20px;">Error loading unit details: ' + errorMsg + '</div>';
                }
            } catch (error) {
                console.error('Error loading unit detail:', error);
                document.getElementById('unitDetailContent').innerHTML = '<div style="color: #dc2626; padding: 20px;">Error loading unit details. Please try again.</div>';
            }
        }
        
        function renderUnitDetailSidebar(unit) {
            const sidebar = document.getElementById('unitDetailSidebar');
            const status = unit.Status || 'Available';
            const statusColor = status === 'Available' ? '#10b981' : status === 'Occupied' ? '#3b82f6' : '#f59e0b';
            const statusBg = status === 'Available' ? '#d1fae5' : status === 'Occupied' ? '#dbeafe' : '#fef3c7';
            const statusTextColor = status === 'Available' ? '#065f46' : status === 'Occupied' ? '#1e40af' : '#92400e';
            
            const html = `
                <div style="margin-bottom: 24px;">
                    <div style="background: ${statusBg}; color: ${statusTextColor}; padding: 12px 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600; font-size: 14px;">UNIT ${unit.Unit_Number || ''}</span>
                        <span style="font-weight: 600; font-size: 12px; text-transform: uppercase;">${status}</span>
                    </div>
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="fas fa-building" style="color: #6b7280; font-size: 18px;"></i>
                            <div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 2px;">Unit type</div>
                                <div style="font-size: 14px; font-weight: 500; color: #111827;">${unit.Size || 'Standard'}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${status === 'Available' ? `
                        <button class="btn btn-primary" onclick="openScheduleMoveInModal('${unit.Unit_ID}')" style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-arrow-right"></i> Schedule move-in
                        </button>
                    ` : ''}
                    
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                        <a href="#" onclick="switchUnitDetailTab('overview'); return false;" style="display: flex; align-items: center; gap: 12px; padding: 8px 0; color: ${currentUnitDetailTab === 'overview' ? '#2563eb' : '#374151'}; text-decoration: none; font-size: 14px; font-weight: ${currentUnitDetailTab === 'overview' ? '600' : '400'};">
                            <i class="fas fa-chart-line"></i> Overview
                        </a>
                        <a href="#" onclick="switchUnitDetailTab('details'); return false;" style="display: flex; align-items: center; gap: 12px; padding: 8px 0; color: ${currentUnitDetailTab === 'details' ? '#2563eb' : '#374151'}; text-decoration: none; font-size: 14px; font-weight: ${currentUnitDetailTab === 'details' ? '600' : '400'};">
                            <i class="fas fa-info-circle"></i> Details
                        </a>
                        <a href="#" onclick="switchUnitDetailTab('previous'); return false;" style="display: flex; align-items: center; gap: 12px; padding: 8px 0; color: ${currentUnitDetailTab === 'previous' ? '#2563eb' : '#374151'}; text-decoration: none; font-size: 14px; font-weight: ${currentUnitDetailTab === 'previous' ? '600' : '400'};">
                            <i class="fas fa-history"></i> Previous rentals
                        </a>
                        <a href="#" onclick="switchUnitDetailTab('history'); return false;" style="display: flex; align-items: center; gap: 12px; padding: 8px 0; color: ${currentUnitDetailTab === 'history' ? '#2563eb' : '#374151'}; text-decoration: none; font-size: 14px; font-weight: ${currentUnitDetailTab === 'history' ? '600' : '400'};">
                            <i class="fas fa-clock"></i> History
                        </a>
                    </div>
                </div>
            `;
            
            sidebar.innerHTML = html;
        }
        
        function renderUnitDetailTab(tab) {
            if (!currentUnitDetail) return;
            
            const content = document.getElementById('unitDetailContent');
            
            if (tab === 'overview') {
                renderOverviewTab(content);
            } else if (tab === 'details') {
                renderDetailsTab(content);
            } else if (tab === 'previous') {
                renderPreviousRentalsTab(content);
            } else if (tab === 'history') {
                renderHistoryTab(content);
            }
        }
        
        function renderOverviewTab(container) {
            const unit = currentUnitDetail;
            const revenue = unit.Revenue || unit.revenue || [];
            const totalRevenue = unit.Total_Revenue || unit.totalRevenue || 0;
            const monthlyRevenue = unit.Monthly_Revenue || unit.monthlyRevenue || 0;
            
            const html = `
                <div style="padding: 24px 0;">
                    <!-- Revenue Summary -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                        <div style="background: #f9fafb; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Revenue</div>
                            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">$${totalRevenue.toFixed(2)}</div>
                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">All time</div>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Monthly Rate</div>
                            <div style="font-size: 32px; font-weight: 700; color: #10b981;">$${monthlyRevenue.toFixed(2)}</div>
                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Current rate</div>
                        </div>
                    </div>
                    
                    <!-- Revenue Chart -->
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 16px 0;">Revenue Over Time (Last 12 Months)</h3>
                        <canvas id="unitRevenueChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Revenue History Table -->
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 16px 0;">Revenue History</h3>
                        ${revenue && revenue.length > 0 ? `
                            <div class="table-container" style="margin: 0; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                            <th>Payment Method</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${revenue.map(r => `
                                            <tr>
                                                <td>${r.Date ? new Date(r.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}</td>
                                                <td>$${parseFloat(r.Amount || 0).toFixed(2)}</td>
                                                <td>${r.Type || 'Rent'}</td>
                                                <td>${r.Payment_Method || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding: 40px; text-align: center; color: #6b7280;">
                                <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                <p>No revenue history available</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render chart if revenue data exists
            if (revenue && revenue.length > 0) {
                setTimeout(() => renderUnitRevenueChart(revenue), 100);
            }
        }
        
        function renderInvoicesTab(container) {
            const unit = currentUnitDetail;
            const invoices = unit.Invoices || unit.invoices || [];
            
            const html = `
                <div style="padding: 24px 0;">
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 16px 0;">Invoices</h3>
                        ${invoices && invoices.length > 0 ? `
                            <div class="table-container" style="margin: 0; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Invoice ID</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoices.map(inv => {
                                            const statusColors = {
                                                'Draft': { bg: '#fef3c7', text: '#92400e' },
                                                'Sent': { bg: '#dbeafe', text: '#1e40af' },
                                                'Paid': { bg: '#d1fae5', text: '#065f46' },
                                                'Failed': { bg: '#fee2e2', text: '#991b1b' },
                                                'Pending': { bg: '#f3f4f6', text: '#374151' }
                                            };
                                            const statusColor = statusColors[inv.Status || 'Draft'] || statusColors['Draft'];
                                            const invoiceId = inv.Invoice_ID || inv.invoiceId || '';
                                            return `
                                                <tr>
                                                    <td><code style="font-size: 12px;">${invoiceId}</code></td>
                                                    <td>${inv.Date ? new Date(inv.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}</td>
                                                    <td>$${parseFloat(inv.Amount || 0).toFixed(2)}</td>
                                                    <td>${inv.Due_Date ? new Date(inv.Due_Date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}</td>
                                                    <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${statusColor.bg}; color: ${statusColor.text};">${inv.Status || 'Draft'}</span></td>
                                                    <td><button class="btn btn-sm btn-secondary" onclick="viewInvoiceDetail('${invoiceId}')">View</button></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding: 40px; text-align: center; color: #6b7280;">
                                <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                <p>No invoices found for this unit</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderDetailsTab(container) {
            const unit = currentUnitDetail;
            const size = unit.Size || '';
            // Parse size to calculate area and volume (assuming format like "124510ft" or "10x10")
            const sizeMatch = size.match(/(\d+)[x](\d+)(?:[x](\d+))?/);
            let area = '';
            let volume = '';
            if (sizeMatch) {
                const dim1 = parseFloat(sizeMatch[1] || 0);
                const dim2 = parseFloat(sizeMatch[2] || 0);
                const dim3 = parseFloat(sizeMatch[3] || 10); // Default height if not specified
                area = (dim1 * dim2).toFixed(0) + 'ft';
                volume = (dim1 * dim2 * dim3).toFixed(0) + 'ft';
            }
            
            const html = `
                <div style="padding: 0;">
                    <div style="background: #ffffff; border-radius: 8px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">Unit details</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-icon" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon" title="More options"><i class="fas fa-ellipsis-v"></i></button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px 40px;">
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Type</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${size || 'Standard'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Name</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${unit.Unit_Number || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Area</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${area || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Volume</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${volume || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Default price</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">$${(unit.Monthly_Rate || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Default deposit</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">$${((unit.Monthly_Rate || 0) * 1).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Size</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${size || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Floor</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">1</div>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px;">Features</div>
                                <div style="font-size: 15px; font-weight: 500; color: #111827;">${unit.Features || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderPreviousRentalsTab(container) {
            const unit = currentUnitDetail;
            
            const html = `
                <div style="padding: 0;">
                    <div style="background: #ffffff; border-radius: 8px; padding: 24px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Previous rentals</h3>
                        <div style="padding: 40px; text-align: center; color: #6b7280;">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                            <p>No previous rentals found</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderHistoryTab(container) {
            const unit = currentUnitDetail;
            
            const html = `
                <div style="padding: 0;">
                    <div style="background: #ffffff; border-radius: 8px; padding: 24px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">History</h3>
                        <div style="padding: 40px; text-align: center; color: #6b7280;">
                            <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                            <p>No history available</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function openScheduleMoveInModal(unitId) {
            const unit = unitsData.find(u => u.Unit_ID === unitId);
            if (!unit) {
                showToast('Unit not found', 'error');
                return;
            }
            
            document.getElementById('scheduleMoveInUnitId').value = unitId;
            document.getElementById('scheduleMoveInCustomer').value = '';
            document.getElementById('scheduleMoveInCustomerId').value = '';
            document.getElementById('scheduleMoveInDate').value = '';
            document.getElementById('scheduleMoveInDeposit').value = unit.Monthly_Rate || '100';
            document.getElementById('scheduleMoveInPrice').value = unit.Monthly_Rate || '100.00';
            document.getElementById('scheduleMoveInPrepayment').value = 'none';
            document.getElementById('scheduleMoveInPromoCode').value = '';
            
            document.getElementById('scheduleMoveInModal').style.display = 'flex';
        }
        
        function closeScheduleMoveInModal() {
            document.getElementById('scheduleMoveInModal').style.display = 'none';
        }
        
        let customersDropdownOpen = false;
        let customersList = [];
        
        async function selectScheduleMoveInCustomer() {
            const customerInput = document.getElementById('scheduleMoveInCustomer');
            let dropdown = document.getElementById('customerDropdown');
            
            if (!dropdown) {
                // Create dropdown if it doesn't exist
                const dropdownDiv = document.createElement('div');
                dropdownDiv.id = 'customerDropdown';
                dropdownDiv.className = 'customer-dropdown';
                dropdownDiv.style.cssText = 'position: absolute; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000; display: none; margin-top: 4px;';
                customerInput.parentElement.style.position = 'relative';
                customerInput.parentElement.appendChild(dropdownDiv);
                dropdown = dropdownDiv;
            }
            
            if (customersList.length === 0) {
                // Load customers
                try {
                    const response = await fetch(`${API_URL}?action=getCustomers&facilityId=${currentFacilityId}`);
                    const result = await response.json();
                    if (result.success && result.customers) {
                        customersList = result.customers;
                    }
                } catch (error) {
                    console.error('Error loading customers:', error);
                }
            }
            if (customersDropdownOpen) {
                dropdown.style.display = 'none';
                customersDropdownOpen = false;
            } else {
                // Filter customers based on input
                const searchTerm = customerInput.value.toLowerCase();
                const filtered = customersList.filter(c => {
                    const name = ((c.First_Name || '') + ' ' + (c.Last_Name || '')).toLowerCase();
                    const email = (c.Email || '').toLowerCase();
                    return name.includes(searchTerm) || email.includes(searchTerm);
                });
                
                dropdown.innerHTML = filtered.length > 0 
                    ? filtered.map(c => `
                        <div class="customer-dropdown-item" onclick="selectCustomer('${c.Customer_ID}', '${(c.First_Name || '')} ${(c.Last_Name || '')}', '${c.Email || ''}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            <div style="font-weight: 600; color: #111827;">${(c.First_Name || '')} ${(c.Last_Name || '')}</div>
                            <div style="font-size: 13px; color: #6b7280;">${c.Email || ''}</div>
                        </div>
                    `).join('')
                    : '<div style="padding: 12px; color: #6b7280; text-align: center;">No customers found</div>';
                
                dropdown.style.display = 'block';
                customersDropdownOpen = true;
            }
        }
        
        function selectCustomer(customerId, name, email) {
            document.getElementById('scheduleMoveInCustomer').value = email;
            document.getElementById('scheduleMoveInCustomerId').value = customerId;
            document.getElementById('customerDropdown').style.display = 'none';
            customersDropdownOpen = false;
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const customerInput = document.getElementById('scheduleMoveInCustomer');
            const dropdown = document.getElementById('customerDropdown');
            if (customerInput && dropdown && !customerInput.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
                customersDropdownOpen = false;
            }
        });
        
        function addNewCustomerForMoveIn() {
            closeScheduleMoveInModal();
            openCustomerModal();
        }
        
        function resetScheduleMoveInPrice() {
            const unitId = document.getElementById('scheduleMoveInUnitId').value;
            const unit = unitsData.find(u => u.Unit_ID === unitId);
            if (unit) {
                document.getElementById('scheduleMoveInPrice').value = unit.Monthly_Rate || '100.00';
            }
        }
        
        let promoCodesList = [];
        let promoDropdownOpen = false;
        
        async function selectPromoCode() {
            const promoInput = document.getElementById('scheduleMoveInPromoCode');
            let dropdown = document.getElementById('promoDropdown');
            
            if (!dropdown) {
                // Create dropdown if it doesn't exist
                const dropdownDiv = document.createElement('div');
                dropdownDiv.id = 'promoDropdown';
                dropdownDiv.className = 'promo-dropdown';
                dropdownDiv.style.cssText = 'position: absolute; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 4px;';
                promoInput.parentElement.style.position = 'relative';
                promoInput.parentElement.appendChild(dropdownDiv);
                dropdown = dropdownDiv;
            }
            
            if (promoCodesList.length === 0) {
                // Load promo codes
                try {
                    const response = await fetch(`${API_URL}?action=getPromoCodes&facilityId=${currentFacilityId}`);
                    const result = await response.json();
                    if (result.success && result.promoCodes) {
                        promoCodesList = result.promoCodes;
                    }
                } catch (error) {
                    console.error('Error loading promo codes:', error);
                }
            }
            if (promoDropdownOpen) {
                dropdown.style.display = 'none';
                promoDropdownOpen = false;
            } else {
                dropdown.innerHTML = promoCodesList.length > 0
                    ? promoCodesList.map(promo => `
                        <div class="promo-dropdown-item" onclick="selectPromo('${promo.code}', '${promo.description}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            <div style="font-weight: 600; color: #111827;">${promo.code}</div>
                            <div style="font-size: 13px; color: #6b7280;">${promo.description}</div>
                        </div>
                    `).join('')
                    : '<div style="padding: 12px; color: #6b7280; text-align: center;">No promo codes available</div>';
                
                dropdown.style.display = 'block';
                promoDropdownOpen = true;
            }
        }
        
        function selectPromo(code, description) {
            document.getElementById('scheduleMoveInPromoCode').value = code;
            document.getElementById('promoDropdown').style.display = 'none';
            promoDropdownOpen = false;
            showToast(`Promo code "${code}" selected: ${description}`, 'success');
        }
        
        // Close promo dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const promoInput = document.getElementById('scheduleMoveInPromoCode');
            const dropdown = document.getElementById('promoDropdown');
            if (promoInput && dropdown && !promoInput.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
                promoDropdownOpen = false;
            }
        });
        
        function createCustomPromoCode() {
            // TODO: Show custom promo code dialog
            showToast('Custom promo code feature coming soon', 'info');
        }
        
        async function saveScheduleMoveIn(event) {
            event.preventDefault();
            
            const unitId = document.getElementById('scheduleMoveInUnitId').value;
            const customerEmail = document.getElementById('scheduleMoveInCustomer').value;
            const moveInDate = document.getElementById('scheduleMoveInDate').value;
            const deposit = parseFloat(document.getElementById('scheduleMoveInDeposit').value);
            const price = parseFloat(document.getElementById('scheduleMoveInPrice').value);
            const prepayment = document.getElementById('scheduleMoveInPrepayment').value;
            const promoCode = document.getElementById('scheduleMoveInPromoCode').value;
            
            if (!unitId || !customerEmail || !moveInDate || !deposit || !price) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
            
            try {
                // Use form-urlencoded POST to avoid CORS preflight
                const formData = new URLSearchParams();
                formData.append('action', 'scheduleMoveIn');
                formData.append('unitId', unitId);
                formData.append('facilityId', currentFacilityId);
                formData.append('customerEmail', customerEmail);
                formData.append('moveInDate', moveInDate);
                formData.append('deposit', deposit.toString());
                formData.append('price', price.toString());
                formData.append('prepayment', prepayment);
                if (promoCode) formData.append('promoCode', promoCode);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.checkoutUrl) {
                        // Open Stripe checkout in new tab
                        window.open(result.checkoutUrl, '_blank');
                        showToast('Opening payment page...', 'success');
                        closeScheduleMoveInModal();
                    } else {
                        showToast('Move-in scheduled successfully', 'success');
                        closeScheduleMoveInModal();
                        loadUnits();
                        loadOverview();
                    }
                } else {
                    throw new Error(result.error || 'Failed to schedule move-in');
                }
            } catch (error) {
                console.error('Error scheduling move-in:', error);
                showToast('Error scheduling move-in: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        function renderUnitRevenueChart(revenue) {
            const ctx = document.getElementById('unitRevenueChart');
            if (!ctx || !revenue || revenue.length === 0) return;
            
            // Group revenue by month for the last 12 months
            const months = [];
            const amounts = [];
            const now = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                months.push(monthKey);
                
                // Sum revenue for this month
                let monthTotal = 0;
                revenue.forEach(r => {
                    if (r.Date) {
                        const rDate = new Date(r.Date);
                        if (rDate.getFullYear() === date.getFullYear() && rDate.getMonth() === date.getMonth()) {
                            monthTotal += parseFloat(r.Amount || 0);
                        }
                    }
                });
                amounts.push(monthTotal);
            }
            
            if (window.unitRevenueChartInstance) {
                window.unitRevenueChartInstance.destroy();
            }
            
            window.unitRevenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Revenue',
                        data: amounts,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function editUnit(unitId) {
            openUnitModal(unitId);
        }

        async function deleteUnit(unitId) {
            if (!confirm('Are you sure you want to delete this unit?')) return;
            
            try {
                const response = await fetch(`${API_URL}?action=deleteUnit&unitId=${unitId}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast('Unit deleted successfully', 'success');
                    loadUnits();
                    loadOverview();
                } else {
                    throw new Error(result.error || 'Failed to delete unit');
                }
            } catch (error) {
                console.error('Error deleting unit:', error);
                showToast('Error deleting unit: ' + error.message, 'error');
            }
        }

        function openCustomerModal(customerId = null) {
            const modal = document.getElementById('customerModal');
            const form = document.getElementById('customerForm');
            const title = document.getElementById('customerModalTitle');
            
            if (customerId) {
                title.textContent = 'Edit Customer';
                const customer = customersData.find(c => c.Customer_ID === customerId);
                if (customer) {
                    document.getElementById('customerId').value = customerId;
                    document.getElementById('customerFirstName').value = customer.First_Name || '';
                    document.getElementById('customerLastName').value = customer.Last_Name || '';
                    document.getElementById('customerEmail').value = customer.Email || '';
                    document.getElementById('customerPhone').value = customer.Phone || '';
                    document.getElementById('customerUnit').value = customer.Unit_Number || '';
                    document.getElementById('customerGateCode').value = customer.Gate_Code || '';
                }
            } else {
                title.textContent = 'Add Customer';
                form.reset();
                document.getElementById('customerId').value = '';
                document.getElementById('customerGateCode').value = '';
            }
            
            modal.classList.add('show');
        }
        
        function generateRandomGateCode() {
            const code = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            document.getElementById('customerGateCode').value = code;
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('show');
        }

        async function saveCustomer(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const customerId = formData.get('customerId');
            const gateCode = formData.get('Gate_Code');
            
            // Validate gate code if provided
            if (gateCode && !/^\d{4}$/.test(gateCode)) {
                showToast('Gate code must be exactly 4 digits', 'error');
                return;
            }
            
            const data = {
                Facility_ID: currentFacilityId,
                First_Name: formData.get('First_Name'),
                Last_Name: formData.get('Last_Name'),
                Email: formData.get('Email'),
                Phone: formData.get('Phone'),
                Unit_Number: formData.get('Unit_Number') || null
            };
            
            // Only include gate code if provided (for new customers, backend will auto-generate)
            if (gateCode) {
                data.Gate_Code = gateCode;
            }
            
            try {
                const url = customerId
                    ? `${API_URL}?action=updateCustomer&customerId=${customerId}&data=${encodeURIComponent(JSON.stringify(data))}`
                    : `${API_URL}?action=createCustomer&data=${encodeURIComponent(JSON.stringify(data))}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    const message = customerId 
                        ? ' Customer updated successfully' 
                        : ` Customer created successfully${result.gateCode ? ' (Gate Code: ' + result.gateCode + ')' : ''}`;
                    showToast(message, 'success');
                    closeCustomerModal();
                    loadCustomers();
                    loadOverview();
                } else {
                    throw new Error(result.error || 'Failed to save customer');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showToast('Error saving customer: ' + error.message, 'error');
            }
        }

        function editCustomer(customerId) {
            openCustomerModal(customerId);
        }

        let sitemapUnits = {}; // Store unit shapes by unitId

        function initSitemap() {
            const canvasContainer = document.getElementById('sitemapCanvas');
            if (!canvasContainer) {
                console.error('Sitemap canvas container not found');
                return;
            }
            
            // Destroy existing stage if it exists
            if (sitemapStage) {
                sitemapStage.destroy();
                sitemapStage = null;
                sitemapLayer = null;
            }
            
            // Get container dimensions
            const container = document.querySelector('.sitemap-container');
            const width = container ? (container.clientWidth - 48) : 800;
            const height = 600;
            
            // Create Konva stage
            sitemapStage = new Konva.Stage({
                container: 'sitemapCanvas',
                width: width,
                height: height
            });
            
            // Create main layer for units
            sitemapLayer = new Konva.Layer();
            sitemapStage.add(sitemapLayer);
            
            // Add grid background layer
            const gridLayer = new Konva.Layer();
            drawGrid(gridLayer, width, height);
            sitemapStage.add(gridLayer);
            gridLayer.moveToBottom();
            
            // Add transformer for resizing/rotating
            if (!sitemapTransformer) {
                sitemapTransformer = new Konva.Transformer({
                    rotateEnabled: true,
                    borderEnabled: true,
                    borderStroke: '#3b82f6',
                    borderStrokeWidth: 2,
                    anchorFill: '#3b82f6',
                    anchorStroke: '#ffffff',
                    anchorSize: 8
                });
                sitemapLayer.add(sitemapTransformer);
            }
            
            // Handle clicks for selection and editing
            sitemapLayer.on('click tap', function(e) {
                // Stop propagation on unit click to prevent edit dialog
                if (e.target.getParent() && e.target.getParent().hasName('unitGroup')) {
                    e.cancelBubble = true;
                }
                
                if (e.target === sitemapLayer || e.target === sitemapStage || e.target.hasName('unitGroup') === false) {
                    sitemapTransformer.nodes([]);
                    return;
                }
                
                // Find the unit group (could be the clicked element or its parent)
                let clickedGroup = e.target;
                while (clickedGroup && !clickedGroup.hasName('unitGroup')) {
                    clickedGroup = clickedGroup.getParent();
                }
                
                if (clickedGroup && clickedGroup.hasName('unitGroup')) {
                    sitemapTransformer.nodes([clickedGroup]);
                    sitemapTransformer.attachTo(clickedGroup);
                    sitemapLayer.draw();
                }
            });
            
            // Handle drag end to update transformer position
            sitemapLayer.on('dragend', function(e) {
                if (e.target && e.target.hasName && e.target.hasName('unitGroup')) {
                    if (sitemapTransformer.nodes().includes(e.target)) {
                        sitemapTransformer.forceUpdate();
                        sitemapLayer.draw();
                    }
                }
            });
            
            // Load existing sitemap data
            loadSitemap();
        }

        function drawGrid(layer, width, height) {
            const gridSize = 20;
            const gridColor = '#e2e8f0';
            
            // Vertical lines
            for (let x = 0; x <= width; x += gridSize) {
                layer.add(new Konva.Line({
                    points: [x, 0, x, height],
                    stroke: gridColor,
                    strokeWidth: 1
                }));
            }
            
            // Horizontal lines
            for (let y = 0; y <= height; y += gridSize) {
                layer.add(new Konva.Line({
                    points: [0, y, width, y],
                    stroke: gridColor,
                    strokeWidth: 1
                }));
            }
        }

        async function loadSitemap() {
            try {
                // First load units
                const unitsResponse = await fetch(`${API_URL}?action=getUnits&facilityId=${currentFacilityId}&status=all`);
                const unitsResult = await unitsResponse.json();
                
                if (unitsResult.success) {
                    unitsData = unitsResult.units || [];
                }
                
                // Then load saved sitemap positions
                const sitemapResponse = await fetch(`${API_URL}?action=getSitemap&facilityId=${currentFacilityId}`);
                const sitemapResult = await sitemapResponse.json();
                
                if (sitemapResult.success && sitemapResult.sitemapData && sitemapResult.sitemapData.units) {
                    renderSitemapUnits(sitemapResult.sitemapData);
                } else {
                    renderSitemapFromUnits();
                }
            } catch (error) {
                console.error('Error loading sitemap:', error);
                renderSitemapFromUnits();
            }
        }

        function renderSitemapFromUnits() {
            if (!sitemapLayer) return;
            
            sitemapLayer.destroyChildren();
            sitemapUnits = {};
            
            unitsData.forEach((unit, index) => {
                const x = 50 + (index % 6) * 140;
                const y = 50 + Math.floor(index / 6) * 100;
                
                createUnitShape(unit, x, y, 120, 80);
            });
            
            sitemapLayer.draw();
        }

        function renderSitemapUnits(sitemapData) {
            if (!sitemapLayer) return;
            
            sitemapLayer.destroyChildren();
            sitemapUnits = {};
            
            const savedPositions = {};
            if (sitemapData.units) {
                sitemapData.units.forEach(saved => {
                    savedPositions[saved.unitId] = saved;
                });
            }
            
            unitsData.forEach((unit, index) => {
                const saved = savedPositions[unit.Unit_ID];
                const x = saved ? saved.x : (50 + (index % 6) * 140);
                const y = saved ? saved.y : (50 + Math.floor(index / 6) * 100);
                const width = saved ? saved.width : 120;
                const height = saved ? saved.height : 80;
                
                createUnitShape(unit, x, y, width, height);
            });
            
            sitemapLayer.draw();
        }

        function createUnitShape(unit, x, y, width, height) {
            const unitId = unit.Unit_ID;
            const status = unit.Status || 'Available';
            const unitNumber = unit.Unit_Number || '';
            
            // Create group for unit
            const group = new Konva.Group({
                x: x,
                y: y,
                draggable: true,
                id: unitId,
                name: 'unitGroup'
            });
            
            // Background rectangle
            const rect = new Konva.Rect({
                width: width,
                height: height,
                fill: getStatusColor(status),
                stroke: '#1e293b',
                strokeWidth: 2,
                cornerRadius: 6,
                shadowColor: 'rgba(0, 0, 0, 0.2)',
                shadowBlur: 4,
                shadowOffset: { x: 2, y: 2 }
            });
            
            // Unit number text
            const text = new Konva.Text({
                y: height / 2 - 10,
                width: width,
                text: unitNumber,
                fontSize: 16,
                fontStyle: 'bold',
                align: 'center',
                fill: 'white',
                verticalAlign: 'middle'
            });
            
            // Size text
            const sizeText = new Konva.Text({
                y: height / 2 + 8,
                width: width,
                text: unit.Size || '',
                fontSize: 11,
                align: 'center',
                fill: 'rgba(255, 255, 255, 0.9)'
            });
            
            group.add(rect);
            group.add(text);
            group.add(sizeText);
            
            // Add click handler - allow transformer to work first
            group.on('click', (e) => {
                // Don't edit immediately - let transformer handle selection
                e.cancelBubble = true;
            });
            
            // Double-click to edit unit details
            group.on('dblclick', () => {
                editUnit(unitId);
            });
            
            // Add drag end handler to save position
            group.on('dragend', () => {
                saveSitemapPositions();
                // Update transformer after drag
                if (sitemapTransformer && sitemapTransformer.nodes().includes(group)) {
                    sitemapTransformer.forceUpdate();
                    sitemapLayer.draw();
                }
            });
            
            // Handle transform (resize/rotate) to save
            group.on('transformend', () => {
                saveSitemapPositions();
            });
            
            sitemapLayer.add(group);
            sitemapUnits[unitId] = group;
        }

        function saveSitemapPositions() {
            // This will be called when saving the full sitemap
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Occupied': return '#3b82f6';
                case 'Reserved': return '#f59e0b';
                case 'Available': return '#10b981';
                default: return '#94a3b8';
            }
        }

        function zoomIn() {
            if (sitemapStage && sitemapLayer) {
                const scale = sitemapStage.scaleX();
                sitemapStage.scale({ x: scale * 1.2, y: scale * 1.2 });
                sitemapLayer.draw();
            }
        }

        function zoomOut() {
            if (sitemapStage && sitemapLayer) {
                const scale = sitemapStage.scaleX();
                sitemapStage.scale({ x: scale / 1.2, y: scale / 1.2 });
                sitemapLayer.draw();
            }
        }

        function resetZoom() {
            if (sitemapStage && sitemapLayer) {
                sitemapStage.scale({ x: 1, y: 1 });
                sitemapStage.position({ x: 0, y: 0 });
                sitemapLayer.draw();
            }
        }

        function fitToScreen() {
            if (!sitemapStage || !sitemapLayer || unitsData.length === 0) {
                resetZoom();
                return;
            }
            
            // Calculate bounding box of all units
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            Object.keys(sitemapUnits).forEach(unitId => {
                const group = sitemapUnits[unitId];
                if (group) {
                    const rect = group.findOne('Rect');
                    const x = group.x();
                    const y = group.y();
                    const w = rect ? rect.width() : 120;
                    const h = rect ? rect.height() : 80;
                    
                    minX = Math.min(minX, x);
                    minY = Math.min(minY, y);
                    maxX = Math.max(maxX, x + w);
                    maxY = Math.max(maxY, y + h);
                }
            });
            
            if (minX !== Infinity) {
                const padding = 50;
                const contentWidth = maxX - minX + padding * 2;
                const contentHeight = maxY - minY + padding * 2;
                const stageWidth = sitemapStage.width();
                const stageHeight = sitemapStage.height();
                
                const scaleX = stageWidth / contentWidth;
                const scaleY = stageHeight / contentHeight;
                const scale = Math.min(scaleX, scaleY, 1); // Don't zoom in beyond 1x
                
                sitemapStage.scale({ x: scale, y: scale });
                sitemapStage.position({
                    x: -minX * scale + padding * scale,
                    y: -minY * scale + padding * scale
                });
                sitemapLayer.draw();
            } else {
                resetZoom();
            }
        }

        async function saveSitemap() {
            if (!sitemapStage || !sitemapLayer) return;
            
            const units = [];
            Object.keys(sitemapUnits).forEach(unitId => {
                const group = sitemapUnits[unitId];
                if (group) {
                    // Get size from the rect inside the group
                    const rect = group.findOne('Rect');
                    units.push({
                        unitId: unitId,
                        x: group.x(),
                        y: group.y(),
                        width: rect ? rect.width() : 120,
                        height: rect ? rect.height() : 80
                    });
                }
            });
            
            const sitemapData = { units: units };
            
            try {
                const response = await fetch(`${API_URL}?action=saveSitemap&facilityId=${currentFacilityId}&sitemapData=${encodeURIComponent(JSON.stringify(sitemapData))}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast('Sitemap saved successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save sitemap');
                }
            } catch (error) {
                console.error('Error saving sitemap:', error);
                showToast('Error saving sitemap: ' + error.message, 'error');
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}?action=getFacilityDetails&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success && result.facility) {
                    const f = result.facility;
                    document.getElementById('settingFacilityName').value = f.Facility_Name || '';
                    document.getElementById('settingAddress').value = f.Address || '';
                    document.getElementById('settingPhone').value = f.Phone || '';
                    document.getElementById('settingEmail').value = f.Email || '';
                    document.getElementById('settingHidePortal').checked = f.Hide_In_Customer_Portal === true || f.Hide_In_Customer_Portal === 'TRUE';
                    document.getElementById('settingEnableBooking').checked = f.Enable_Unit_Booking === true || f.Enable_Unit_Booking === 'TRUE';
                    
                    // Load subscription details
                    await loadSubscriptionDetails(f);
                }
                
                // Load payment history
                await loadPaymentHistory();
                
                // Load QuickBooks status
                await loadQuickBooksStatus();

                // Load API key for this facility
                await loadApiKey();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        async function loadSubscriptionDetails(facility) {
            try {
                const subscriptionStatus = facility.Subscription_Status || 'Active';
                const monthlyFee = facility.Monthly_Fee || 0;
                const subscriptionPlan = facility.Subscription_Plan || 'Professional';
                const lastPaymentDate = facility.Last_Payment_Date || facility.Created_Date || '';
                const createdDate = facility.Created_Date || '';
                
                // Check if promo code is applied (1YEARFREE or if plan contains "Promo" or "1 Year Free")
                const hasPromo = subscriptionPlan.includes('Promo') || subscriptionPlan.includes('1 Year Free') || subscriptionPlan.includes('1YEARFREE');
                let promoEndDate = null;
                let promoCode = '';
                
                if (hasPromo) {
                    // For 1YEARFREE promo, the Last_Payment_Date is set to 1 year from creation
                    // So the promo ends when Last_Payment_Date is reached
                    if (lastPaymentDate) {
                        promoEndDate = new Date(lastPaymentDate);
                    } else if (createdDate) {
                        // Fallback: calculate 1 year from creation
                        promoEndDate = new Date(createdDate);
                        promoEndDate.setFullYear(promoEndDate.getFullYear() + 1);
                    }
                    
                    // Extract promo code from plan name or check facility data
                    if (subscriptionPlan.includes('1YEARFREE') || subscriptionPlan.includes('1 Year Free')) {
                        promoCode = '1YEARFREE';
                    }
                }
                
                // Calculate next payment date (30 days from last payment, unless promo active)
                let nextPaymentDate = 'N/A';
                if (hasPromo && promoEndDate) {
                    // If promo is active, next payment is when promo ends
                    const now = new Date();
                    if (promoEndDate > now) {
                        nextPaymentDate = promoEndDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    } else {
                        // Promo has ended
                        const nextPayment = new Date(promoEndDate);
                        nextPayment.setDate(nextPayment.getDate() + 30);
                        nextPaymentDate = nextPayment.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                } else if (lastPaymentDate) {
                    const lastPayment = new Date(lastPaymentDate);
                    lastPayment.setDate(lastPayment.getDate() + 30);
                    nextPaymentDate = lastPayment.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                }
                
                // Update UI
                const statusBadge = document.getElementById('subscriptionStatusBadge');
                const monthlyFeeEl = document.getElementById('subscriptionMonthlyFee');
                const nextPaymentEl = document.getElementById('subscriptionNextPayment');
                const planEl = document.getElementById('subscriptionPlan');
                const cancelBtn = document.getElementById('cancelSubscriptionBtn');
                const reactivateBtn = document.getElementById('reactivateSubscriptionBtn');
                const promoBanner = document.getElementById('promoCodeBanner');
                const promoEndDateEl = document.getElementById('promoEndDate');
                const promoCodeTextEl = document.getElementById('promoCodeText');
                
                // Show/hide promo banner
                if (promoBanner) {
                    if (hasPromo && promoEndDate) {
                        const now = new Date();
                        if (promoEndDate > now) {
                            // Promo is still active
                            promoBanner.style.display = 'block';
                            const endDateStr = promoEndDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                            if (promoEndDateEl) {
                                promoEndDateEl.textContent = endDateStr;
                            }
                            if (promoCodeTextEl && promoCode) {
                                promoCodeTextEl.innerHTML = `Promo code <strong>${promoCode}</strong> applied. You have free software until <strong>${endDateStr}</strong>.`;
                            }
                        } else {
                            // Promo has ended
                            promoBanner.style.display = 'none';
                        }
                    } else {
                        promoBanner.style.display = 'none';
                    }
                }
                
                if (statusBadge) {
                    if (subscriptionStatus === 'Active' || subscriptionStatus === 'active') {
                        statusBadge.textContent = 'Active';
                        statusBadge.style.background = '#d1fae5';
                        statusBadge.style.color = '#065f46';
                        if (cancelBtn) cancelBtn.style.display = 'inline-block';
                        if (reactivateBtn) reactivateBtn.style.display = 'none';
                    } else if (subscriptionStatus === 'Cancelled' || subscriptionStatus === 'cancelled') {
                        statusBadge.textContent = 'Cancelled';
                        statusBadge.style.background = '#fee2e2';
                        statusBadge.style.color = '#991b1b';
                        if (cancelBtn) cancelBtn.style.display = 'none';
                        if (reactivateBtn) reactivateBtn.style.display = 'inline-block';
                    } else {
                        statusBadge.textContent = subscriptionStatus;
                        statusBadge.style.background = '#fef3c7';
                        statusBadge.style.color = '#92400e';
                    }
                }
                
                if (monthlyFeeEl) {
                    // Show $0.00 if promo is active
                    if (hasPromo && promoEndDate && new Date(promoEndDate) > new Date()) {
                        monthlyFeeEl.textContent = '$0.00';
                        monthlyFeeEl.style.color = '#059669';
                    } else {
                        monthlyFeeEl.textContent = `$${parseFloat(monthlyFee).toFixed(2)}`;
                        monthlyFeeEl.style.color = '#111827';
                    }
                }
                
                if (nextPaymentEl) {
                    nextPaymentEl.textContent = nextPaymentDate;
                }
                
                if (planEl) {
                    planEl.textContent = subscriptionPlan;
                }
            } catch (error) {
                console.error('Error loading subscription details:', error);
            }
        }
        
        async function loadPaymentHistory() {
            try {
                const response = await fetch(`${API_URL}?action=getFacilityInvoices&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                const tbody = document.getElementById('paymentHistoryBody');
                if (!tbody) return;
                
                if (result.success && result.invoices && result.invoices.length > 0) {
                    tbody.innerHTML = '';
                    result.invoices.forEach(invoice => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e5e7eb';
                        
                        const date = new Date(invoice.Created_Date || invoice.createdDate || '');
                        const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        const status = invoice.Status || invoice.status || 'Pending';
                        const statusColor = status === 'Paid' ? '#059669' : status === 'Pending' ? '#d97706' : '#dc2626';
                        
                        row.innerHTML = `
                            <td style="padding: 12px; color: #111827;">${dateStr}</td>
                            <td style="padding: 12px; color: #111827; font-family: monospace; font-size: 13px;">${invoice.Invoice_ID || invoice.invoiceId || 'N/A'}</td>
                            <td style="padding: 12px; color: #111827; font-weight: 600;">$${parseFloat(invoice.Amount || invoice.amount || 0).toFixed(2)}</td>
                            <td style="padding: 12px;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${status === 'Paid' ? '#d1fae5' : '#fef3c7'}; color: ${statusColor};">
                                    ${status}
                                </span>
                            </td>
                            <td style="padding: 12px;">
                                ${invoice.Invoice_Token || invoice.invoiceToken ? 
                                    `<a href="#" onclick="viewInvoice('${invoice.Invoice_Token || invoice.invoiceToken}'); return false;" style="color: #3b82f6; text-decoration: none;">View</a>` : 
                                    'N/A'}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No payment history found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                const tbody = document.getElementById('paymentHistoryBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #dc2626;">Error loading payment history</td></tr>';
                }
            }
        }
        
        function confirmCancelSubscription() {
            if (confirm('Are you sure you want to cancel your subscription? Your data will be retained for 30 days in case you want to reactivate. You can reactivate at any time within this period.')) {
                cancelSubscription();
            }
        }
        
        async function cancelSubscription() {
            try {
                const response = await fetch(`${API_URL}?action=cancelFacilitySubscription&facilityId=${currentFacilityId}`, {
                    method: 'GET'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Subscription cancelled', 'Your subscription has been cancelled. Data will be retained for 30 days.', 'success');
                    await loadSettings(); // Reload to update UI
                } else {
                    throw new Error(result.error || 'Failed to cancel subscription');
                }
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                showToast('Error cancelling subscription', error.message, 'error');
            }
        }
        
        async function reactivateSubscription() {
            try {
                const response = await fetch(`${API_URL}?action=reactivateFacilitySubscription&facilityId=${currentFacilityId}`, {
                    method: 'GET'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Subscription reactivated', 'Your subscription has been reactivated successfully.', 'success');
                    await loadSettings(); // Reload to update UI
                } else {
                    throw new Error(result.error || 'Failed to reactivate subscription');
                }
            } catch (error) {
                console.error('Error reactivating subscription:', error);
                showToast('Error reactivating subscription', error.message, 'error');
            }
        }
        
        function viewInvoice(token) {
            // Open invoice in new window or redirect
            const webflowBaseUrl = 'https://www.harbourandhomestorage.com'; // UPDATE THIS
            window.open(`${webflowBaseUrl}/facility-invoice?token=${token}`, '_blank');
        }

        async function loadApiKey() {
            const input = document.getElementById('apiKeyDisplay');
            const copyBtn = document.getElementById('copyApiKeyBtn');
            const generateBtn = document.getElementById('generateApiKeyBtn');

            if (!input || !copyBtn || !generateBtn) return;

            try {
                input.value = '';
                input.placeholder = 'Loading API key...';
                copyBtn.disabled = true;

                const response = await fetch(`${API_URL}?action=getAPIKey&facilityId=${currentFacilityId}`);
                const result = await response.json();

                if (result.success && result.apiKey) {
                    input.value = result.apiKey;
                    input.placeholder = '';
                    copyBtn.disabled = false;
                    generateBtn.textContent = 'Regenerate API key';
                } else {
                    input.value = '';
                    input.placeholder = 'No API key generated yet';
                    copyBtn.disabled = true;
                    generateBtn.textContent = 'Generate API key';
                }
            } catch (error) {
                console.error('Error loading API key:', error);
                input.value = '';
                input.placeholder = 'Error loading API key';
                copyBtn.disabled = true;
            }
        }

        async function generateApiKey() {
            if (!confirm('Generate a new API key? This will revoke access for any systems using the old key.')) {
                return;
            }

            const input = document.getElementById('apiKeyDisplay');
            const copyBtn = document.getElementById('copyApiKeyBtn');
            const generateBtn = document.getElementById('generateApiKeyBtn');

            if (!input || !copyBtn || !generateBtn) return;

            try {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';

                const response = await fetch(`${API_URL}?action=generateAPIKey&facilityId=${currentFacilityId}`);
                const result = await response.json();

                if (result.success && result.apiKey) {
                    input.value = result.apiKey;
                    input.placeholder = '';
                    copyBtn.disabled = false;
                    generateBtn.textContent = 'Regenerate API key';
                    showToast('API key generated successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to generate API key');
                }
            } catch (error) {
                console.error('Error generating API key:', error);
                showToast('Error generating API key: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
            }
        }

        function copyApiKey() {
            const input = document.getElementById('apiKeyDisplay');
            if (!input || !input.value) return;

            input.select();
            input.setSelectionRange(0, 99999); // For mobile

            try {
                document.execCommand('copy');
                showToast('API key copied to clipboard', 'success');
            } catch (error) {
                console.error('Error copying API key:', error);
                showToast('Unable to copy API key', 'error');
            }
        }
        
        async function loadQuickBooksStatus() {
            try {
                const response = await fetch(`${API_URL}?action=getQuickBooksStatus&facilityId=${currentFacilityId}`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result;
                    const statusCard = document.getElementById('qbStatusCard');
                    const statusText = document.getElementById('qbStatusText');
                    const statusLabel = document.getElementById('qbStatusLabel');
                    const statusBadge = document.getElementById('qbStatusBadge');
                    const connectBtn = document.getElementById('qbConnectBtn');
                    const disconnectBtn = document.getElementById('qbDisconnectBtn');
                    const refreshBtn = document.getElementById('qbRefreshBtn');
                    const settingsCard = document.getElementById('qbSettingsCard');
                    const syncCard = document.getElementById('qbSyncCard');
                    const lastSyncDiv = document.getElementById('qbLastSync');
                    const lastSyncTime = document.getElementById('qbLastSyncTime');
                    
                    if (status.connected) {
                        statusText.textContent = `Connected to QuickBooks Company: ${status.companyId || 'N/A'}`;
                        statusLabel.textContent = 'Connected';
                        statusBadge.style.background = '#d1fae5';
                        statusBadge.style.color = '#065f46';
                        connectBtn.style.display = 'none';
                        disconnectBtn.style.display = 'inline-block';
                        refreshBtn.style.display = status.needsRefresh ? 'inline-block' : 'none';
                        settingsCard.style.display = 'block';
                        syncCard.style.display = 'block';
                        
                        // Load settings
                        document.getElementById('qbSyncCustomers').checked = status.syncCustomers || false;
                        document.getElementById('qbSyncInvoices').checked = status.syncInvoices || false;
                        document.getElementById('qbSyncPayments').checked = status.syncPayments || false;
                        document.getElementById('qbIncomeAccount').value = status.incomeAccount || '';
                        document.getElementById('qbPaymentMethod').value = status.paymentMethod || '';
                        document.getElementById('qbItemService').value = status.itemService || '';
                        
                        if (status.lastSync) {
                            const syncDate = new Date(status.lastSync);
                            lastSyncTime.textContent = syncDate.toLocaleString();
                            lastSyncDiv.style.display = 'block';
                        }
                    } else {
                        statusText.textContent = 'QuickBooks is not connected. Connect your account to sync data automatically.';
                        statusLabel.textContent = 'Not Connected';
                        statusBadge.style.background = '#fee2e2';
                        statusBadge.style.color = '#991b1b';
                        connectBtn.style.display = 'inline-block';
                        disconnectBtn.style.display = 'none';
                        refreshBtn.style.display = 'none';
                        settingsCard.style.display = 'none';
                        syncCard.style.display = 'none';
                        lastSyncDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading QuickBooks status:', error);
            }
        }
        
        function connectQuickBooks() {
            window.open(`${API_URL}?action=initiateQuickBooksAuth&facilityId=${currentFacilityId}`, '_blank', 'width=600,height=700');
            // Poll for connection status
            const checkInterval = setInterval(async () => {
                await loadQuickBooksStatus();
                const status = await fetch(`${API_URL}?action=getQuickBooksStatus&facilityId=${currentFacilityId}`).then(r => r.json());
                if (status.success && status.connected) {
                    clearInterval(checkInterval);
                    showToast('QuickBooks connected successfully!', 'success');
                }
            }, 2000);
            
            // Stop checking after 2 minutes
            setTimeout(() => clearInterval(checkInterval), 120000);
        }
        
        async function disconnectQuickBooks() {
            if (!confirm('Are you sure you want to disconnect QuickBooks? This will stop all automatic syncing.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=disconnectQuickBooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ facilityId: currentFacilityId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('QuickBooks disconnected successfully', 'success');
                    await loadQuickBooksStatus();
                } else {
                    showToast(result.error || 'Failed to disconnect', 'error');
                }
            } catch (error) {
                console.error('Error disconnecting QuickBooks:', error);
                showToast('Error disconnecting QuickBooks', 'error');
            }
        }
        
        async function refreshQuickBooksToken() {
            try {
                showToast('Refreshing QuickBooks token...', 'info');
                // Token refresh happens automatically in backend
                await loadQuickBooksStatus();
                showToast('Token refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing token:', error);
                showToast('Error refreshing token', 'error');
            }
        }
        
        async function saveQuickBooksSettings() {
            try {
                const data = {
                    facilityId: currentFacilityId,
                    syncCustomers: document.getElementById('qbSyncCustomers').checked,
                    syncInvoices: document.getElementById('qbSyncInvoices').checked,
                    syncPayments: document.getElementById('qbSyncPayments').checked,
                    incomeAccount: document.getElementById('qbIncomeAccount').value,
                    paymentMethod: document.getElementById('qbPaymentMethod').value,
                    itemService: document.getElementById('qbItemService').value,
                    qbClass: document.getElementById('qbClass').value
                };
                
                const response = await fetch(`${API_URL}?action=updateQuickBooksSettings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('QuickBooks settings saved successfully', 'success');
                } else {
                    showToast(result.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving QuickBooks settings:', error);
                showToast('Error saving settings', 'error');
            }
        }
        
        async function syncQBData(type) {
            const syncStatus = document.getElementById('qbSyncStatus');
            syncStatus.style.display = 'block';
            syncStatus.style.background = '#eff6ff';
            syncStatus.style.color = '#1e40af';
            syncStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            
            try {
                let action;
                if (type === 'customers') {
                    action = 'syncQuickBooksCustomers';
                } else if (type === 'invoices') {
                    action = 'syncQuickBooksInvoices';
                } else if (type === 'payments') {
                    action = 'syncQuickBooksPayments';
                } else {
                    // Sync all
                    const customers = await fetch(`${API_URL}?action=syncQuickBooksCustomers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ facilityId: currentFacilityId })
                    }).then(r => r.json());
                    
                    const invoices = await fetch(`${API_URL}?action=syncQuickBooksInvoices`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ facilityId: currentFacilityId })
                    }).then(r => r.json());
                    
                    const payments = await fetch(`${API_URL}?action=syncQuickBooksPayments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ facilityId: currentFacilityId })
                    }).then(r => r.json());
                    
                    const totalSynced = (customers.synced || 0) + (invoices.synced || 0) + (payments.synced || 0);
                    const totalErrors = (customers.errors || 0) + (invoices.errors || 0) + (payments.errors || 0);
                    
                    syncStatus.style.background = totalErrors > 0 ? '#fef3c7' : '#d1fae5';
                    syncStatus.style.color = totalErrors > 0 ? '#92400e' : '#065f46';
                    syncStatus.innerHTML = `<i class="fas fa-check-circle"></i> Sync complete: ${totalSynced} items synced${totalErrors > 0 ? `, ${totalErrors} errors` : ''}`;
                    
                    await loadQuickBooksStatus();
                    return;
                }
                
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ facilityId: currentFacilityId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    syncStatus.style.background = result.errors > 0 ? '#fef3c7' : '#d1fae5';
                    syncStatus.style.color = result.errors > 0 ? '#92400e' : '#065f46';
                    syncStatus.innerHTML = `<i class="fas fa-check-circle"></i> ${result.synced} items synced${result.errors > 0 ? `, ${result.errors} errors` : ''}`;
                    await loadQuickBooksStatus();
                } else {
                    syncStatus.style.background = '#fee2e2';
                    syncStatus.style.color = '#991b1b';
                    syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${result.error || 'Sync failed'}`;
                }
            } catch (error) {
                console.error('Error syncing QuickBooks:', error);
                syncStatus.style.background = '#fee2e2';
                syncStatus.style.color = '#991b1b';
                syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const updates = {
                Facility_Name: document.getElementById('settingFacilityName').value,
                Address: document.getElementById('settingAddress').value,
                Phone: document.getElementById('settingPhone').value,
                Email: document.getElementById('settingEmail').value,
                Hide_In_Customer_Portal: document.getElementById('settingHidePortal').checked,
                Enable_Unit_Booking: document.getElementById('settingEnableBooking').checked
            };
            
            try {
                const response = await fetch(`${API_URL}?action=updateFacilityFields&facilityId=${currentFacilityId}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast('Settings saved successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Error saving settings: ' + error.message, 'error');
            }
        });

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>

