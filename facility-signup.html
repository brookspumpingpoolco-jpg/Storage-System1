<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Meridian - Storage Facility Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #1e293b;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
            margin-bottom: 12px;
        }

        .tagline {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            font-weight: 400;
        }

        .form-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
            margin-top: 32px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-subtitle {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #334155;
            margin-bottom: 8px;
        }

        .required {
            color: #ef4444;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: #fff;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }


        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }

        .checkbox-label {
            flex: 1;
        }

        .checkbox-label strong {
            display: block;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .checkbox-label small {
            color: #64748b;
            font-size: 13px;
        }

        .pricing-summary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 16px;
            padding: 32px;
            color: white;
            margin-bottom: 32px;
        }

        .pricing-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pricing-item:last-child {
            border-bottom: none;
        }

        .pricing-item.total {
            font-size: 20px;
            font-weight: 700;
            margin-top: 12px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .pricing-label {
            opacity: 0.9;
        }

        .pricing-value {
            font-weight: 600;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-card {
                padding: 32px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Meridian</div>
            <div class="tagline">Professional Storage Facility Management Platform</div>
        </div>

        <form id="signupForm" class="form-card">
            <div class="error-message" id="errorMessage"></div>

            <h2 class="section-title">Facility Information</h2>
            <p class="section-subtitle">Tell us about your storage facility</p>

            <div class="form-grid">
                <div class="form-group">
                    <label>Facility Name <span class="required">*</span></label>
                    <input type="text" name="facilityName" required placeholder="Easy Storage Denver">
                </div>

                <div class="form-group">
                    <label>Owner Name <span class="required">*</span></label>
                    <input type="text" name="ownerName" required placeholder="John Smith">
                </div>

                <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" name="email" required placeholder="john@facility.com">
                </div>

                <div class="form-group">
                    <label>Phone Number <span class="required">*</span></label>
                    <input type="tel" name="phone" required placeholder="(555) 123-4567">
                </div>

                <div class="form-group full-width">
                    <label>Facility Address <span class="required">*</span></label>
                    <textarea name="address" required placeholder="123 Storage Lane, Denver, CO 80202" rows="2"></textarea>
                </div>
            </div>

            <h2 class="section-title">Unit Count</h2>
            <p class="section-subtitle">How many storage units does your facility have? You can add detailed unit information later.</p>

            <div class="form-group">
                <label>Total Number of Units <span class="required">*</span></label>
                <input type="number" id="unitCount" name="unitCount" required min="1" placeholder="Enter total number of units" oninput="updatePricing()">
                <small style="color: #64748b; font-size: 13px; margin-top: 4px; display: block;">You'll be able to add detailed unit information (sizes, rates, etc.) after signup.</small>
            </div>

            <h2 class="section-title">Website Services</h2>
            <p class="section-subtitle">Do you need a professional website for your facility?</p>

            <div class="checkbox-group">
                <input type="checkbox" id="needsWebsite" name="needsWebsite" onchange="updatePricing()">
                <label for="needsWebsite" class="checkbox-label">
                    <strong>Yes, create a professional website for my facility</strong>
                    <small>Includes custom branding, SEO optimization, contact forms, and reservation system. One-time setup fee: $125 | Monthly: $30</small>
                </label>
            </div>

            <h2 class="section-title">Promo Code (Optional)</h2>
            <p class="section-subtitle">Have a promo code? Enter it below to apply discounts.</p>

            <div class="form-group">
                <label>Promo Code</label>
                <input type="text" id="promoCode" name="promoCode" placeholder="Enter promo code" oninput="updatePricing()" style="text-transform: uppercase;">
                <small id="promoCodeMessage" style="color: #10b981; font-size: 13px; margin-top: 4px; display: none; font-weight: 600;"></small>
            </div>

            <div class="pricing-summary">
                <div class="pricing-title">Pricing Summary</div>
                <div class="pricing-item">
                    <span class="pricing-label">Monthly Subscription</span>
                    <span class="pricing-value" id="monthlySubscription">$150.00</span>
                </div>
                <div class="pricing-item">
                    <span class="pricing-label">One-Time Setup Fee</span>
                    <span class="pricing-value">$199.00</span>
                </div>
                <div class="pricing-item">
                    <span class="pricing-label">Annual Facility Fee</span>
                    <span class="pricing-value">$175.00</span>
                </div>
                <div class="pricing-item" id="websiteSetupRow" style="display: none;">
                    <span class="pricing-label">Website Setup (One-Time)</span>
                    <span class="pricing-value">$125.00</span>
                </div>
                <div class="pricing-item" id="websiteMonthlyRow" style="display: none;">
                    <span class="pricing-label">Website Hosting (Monthly)</span>
                    <span class="pricing-value">$30.00</span>
                </div>
                <div class="pricing-item total">
                    <span class="pricing-label">Total Today</span>
                    <span class="pricing-value" id="totalToday">$370.00</span>
                </div>
                <div class="pricing-item" style="margin-top: 8px; font-size: 14px; opacity: 0.9;">
                    <span class="pricing-label">Monthly Recurring</span>
                    <span class="pricing-value" id="monthlyRecurring">$150.00</span>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                Continue to Payment
            </button>
        </form>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby8_MUFwM7Cwvek9MPxO9K_q4Qsbbj6PBl53eama3j6w0gzyYyj4lCUFPyZ9mvDNxkC/exec';

        // Initialize pricing
        window.addEventListener('DOMContentLoaded', () => {
            updatePricing();
        });

        function updatePricing() {
            const needsWebsite = document.getElementById('needsWebsite').checked;
            const unitCountInput = document.getElementById('unitCount');
            const unitCount = parseInt(unitCountInput.value) || 0;
            const promoCodeInput = document.getElementById('promoCode');
            const promoCode = (promoCodeInput.value || '').trim().toUpperCase();
            const promoCodeMessage = document.getElementById('promoCodeMessage');
            
            const websiteSetupRow = document.getElementById('websiteSetupRow');
            const websiteMonthlyRow = document.getElementById('websiteMonthlyRow');
            const totalToday = document.getElementById('totalToday');
            const monthlyRecurring = document.getElementById('monthlyRecurring');
            const monthlySubscription = document.getElementById('monthlySubscription');

            // Calculate monthly fee based on unit count
            // $150 for 1-100 units, then $0.40 per additional unit
            let monthlyFee = 150;
            if (unitCount > 100) {
                const unitsOver100 = unitCount - 100;
                monthlyFee = 150 + (unitsOver100 * 0.40);
            }

            // Setup fee is $199 + Annual fee is $175 = $374 base
            let todayTotal = 199 + 175; // Setup fee + Annual fee

            // Base monthly subscription (before website fee)
            let baseMonthlyFee = monthlyFee;

            if (needsWebsite) {
                todayTotal += 125; // Website setup
                monthlyFee += 30; // Website hosting
                websiteSetupRow.style.display = 'flex';
                websiteMonthlyRow.style.display = 'flex';
            } else {
                websiteSetupRow.style.display = 'none';
                websiteMonthlyRow.style.display = 'none';
            }

            // Apply promo code discounts
            let discountApplied = false;
            let discountMessage = '';
            
            if (promoCode === '1YEARFREE') {
                // 1YEARFREE: Waive all charges and give 1 year free
                todayTotal = 0;
                monthlyFee = 0;
                baseMonthlyFee = 0;
                discountApplied = true;
                discountMessage = '✓ Promo code applied! All charges waived + 1 year free subscription!';
            }
            
            // Show/hide promo code message
            if (promoCode && !discountApplied) {
                promoCodeMessage.textContent = 'Invalid promo code';
                promoCodeMessage.style.color = '#ef4444';
                promoCodeMessage.style.display = 'block';
            } else if (discountApplied) {
                promoCodeMessage.textContent = discountMessage;
                promoCodeMessage.style.color = '#10b981';
                promoCodeMessage.style.display = 'block';
            } else {
                promoCodeMessage.style.display = 'none';
            }

            // Update both monthly subscription and monthly recurring
            monthlySubscription.textContent = `$${baseMonthlyFee.toFixed(2)}`;
            totalToday.textContent = `$${todayTotal.toFixed(2)}`;
            monthlyRecurring.textContent = `$${monthlyFee.toFixed(2)}`;
        }

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('errorMessage');

            // Hide error
            errorMsg.classList.remove('show');

            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            // Collect form data
            const formData = new FormData(e.target);
            const unitCount = parseInt(formData.get('unitCount')) || 0;
            
            if (unitCount < 1) {
                errorMsg.textContent = 'Please enter the number of units (minimum 1)';
                errorMsg.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Continue to Payment';
                return;
            }

            // Get promo code first
            const promoCode = (formData.get('promoCode') || '').trim().toUpperCase();
            const isPromo1YearFree = (promoCode === '1YEARFREE');
            
            // Calculate monthly fee based on unit count
            let monthlyFee = 150;
            if (unitCount > 100) {
                const unitsOver100 = unitCount - 100;
                monthlyFee = 150 + (unitsOver100 * 0.40);
            }

            const needsWebsite = document.getElementById('needsWebsite').checked;
            if (needsWebsite) {
                monthlyFee += 30; // Website hosting
            }
            
            // Apply promo code discount to monthly fee
            if (isPromo1YearFree) {
                monthlyFee = 0; // Free for 1 year
            }
            
            const signupData = {
                facilityName: formData.get('facilityName'),
                ownerName: formData.get('ownerName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                unitCount: unitCount,
                needsWebsite: needsWebsite,
                promoCode: promoCode,
                setupFee: 199,
                monthlyFee: monthlyFee,
                websiteSetupFee: needsWebsite ? 125 : 0,
                websiteMonthlyFee: needsWebsite ? 30 : 0
            };

            try {
                console.log('Submitting signup data:', signupData);
                
                // Use GET with URL parameters to avoid CORS preflight issues with Google Apps Script
                const params = new URLSearchParams({
                    action: 'createFacilitySignup',
                    data: JSON.stringify(signupData)
                });

                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'GET',
                    mode: 'cors'
                });

                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('Response result:', result);

                if (result.success && result.checkoutUrl) {
                    // Check if promo code was applied (checkout URL contains promo parameter)
                    if (result.checkoutUrl.includes('promo=1YEARFREE') || result.checkoutUrl.includes('session_id=PROMO')) {
                        // Promo code applied - redirect directly to success page
                        window.location.href = result.checkoutUrl;
                    } else {
                        // Normal payment - open Stripe checkout in new tab
                        window.open(result.checkoutUrl, '_blank');
                        
                        // Show success message
                        alert('✓ Redirecting to payment...\n\nPlease complete payment in the new window. After payment, you will receive an email with a link to set up your password and access your dashboard.');
                    }
                } else {
                    throw new Error(result.error || 'Failed to create signup');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                errorMsg.textContent = error.message || 'An error occurred. Please try again.';
                errorMsg.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Continue to Payment';
            }
        });
    </script>
</body>
</html>

